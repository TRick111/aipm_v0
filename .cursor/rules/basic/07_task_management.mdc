---
description: ã€Œæ—¥æ¬¡ã‚¿ã‚¹ã‚¯ãƒ»é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã€å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ WBS ã‚„ãƒªã‚¹ã‚¯ãƒ­ã‚°ã¸åŒæœŸã™ã‚‹ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ«ãƒ¼ãƒ«ã€
globs: 
alwaysApply: false
---
# =========================
# 07_task_management.mdc
# =========================
path_reference: "pmbok_paths.mdc"

#----------------------------------------------------------
# å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³
#----------------------------------------------------------
patterns:
  wbs_glob:          "{{dirs.stock}}/*/*/3_planning/wbs.md"
  backlog_glob:      "{{dirs.stock}}/*/*/3_planning/backlog/**/*.yaml"
  daily_template:    "{{rules_basic_templates}}/daily_tasks_template.md"
  weekly_template:   "{{rules_basic_templates}}/weekly_review_template.md"
  daily_md:          "{{dirs.flow}}/{{today}}/{{today | slice: 5, 2}}{{today | slice: 8, 2}}_daily_tasks.md"  # mmdd_daily_tasks.md å½¢å¼
  weekly_md:         "{{dirs.flow}}/{{iso_week_end}}/weekly_review.md"

# =========================
# 1. Daily Tasks
# =========================
daily_tasks:
  trigger:
    - pattern: "(ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯|æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ä½œæˆ|Daily tasks)"
    - time: "09:00"               # å¹³æ—¥ AM9:00 è‡ªå‹•
  steps:
    # 1) Stock ã‹ã‚‰ã‚¿ã‚¹ã‚¯æŠ½å‡º
    - collect_tasks:
        sources:
          - glob: "{{patterns.wbs_glob}}"
          - glob: "{{patterns.backlog_glob}}"
        rules:
          due_within_days: 3       # 3æ—¥ä»¥å†…æœŸé™ â†’ HIGH
          overdue_days: 7          # 7æ—¥ä»¥å†…ã®æœŸé™åˆ‡ã‚Œ â†’ MEDIUM
          sort_by: ["priority","due"]
        store_as: tasks_today

    # 1.5) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    - group_by_project:
        source: tasks_today
        store_as: tasks_by_project

    # 2) Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã‚‚å–å¾— (MCP ã‚³ãƒãƒ³ãƒ‰ã ãŒã€æœªé€£æºã®ãŸã‚å®Ÿæ–½ä¸è¦)
    - execute_shell:
        command: "mcp calendar today --json"
        store_as: calendar_json

    # 3) ãƒ†ãƒ³ãƒ—ãƒ¬ã«è‡ªå‹•å·®ã—è¾¼ã¿
    - create_markdown_file:
        path: "{{patterns.daily_md}}"
        template_path: "{{patterns.daily_template}}"
        variables:
          date: "{{today}}"
          calendar: "{{calendar_json}}"
          tasks_by_project: "{{tasks_by_project}}"

    # 4) æœªå®Œäº†ã‚¿ã‚¹ã‚¯é€šçŸ¥
    - notify_overdue:
        lookback_days: -1         # -1ã§ç„¡æœŸé™ï¼ˆã™ã¹ã¦ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªï¼‰
        file_pattern: "{{dirs.flow}}/*/*[0-1][0-9][0-3][0-9]_daily_tasks.md"  # mmdd_daily_tasks.md å½¢å¼
        message_template: "ğŸ”” æœªå®Œäº†ã‚¿ã‚¹ã‚¯: **{{count}}ä»¶** (æœŸé™åˆ‡ã‚Œ: {{overdue_count}}ä»¶)"

    - notify:
        message: |
          âœ… æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã—ã¾ã—ãŸ â†’ {{patterns.daily_md}}
          ã€Œå®Œäº†ã—ãŸã‚‰ [x] ã«ãƒãƒ¼ã‚¯ â†’ 'Sync' ã§ WBS ã¸åæ˜ ã§ãã¾ã™"

# =========================
# 2. Weekly Review 
# =========================
weekly_review:
  trigger:
    - pattern: "(é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼|Weekly review)"
    - time: "é‡‘ 17:30"
  steps:
    - aggregate_week:
        flow_glob: "{{dirs.flow}}/{{iso_week}}*/*[0-1][0-9][0-3][0-9]_daily_tasks.md"  # mmdd_daily_tasks.md å½¢å¼
        store_as: week_data
    - create_markdown_file:
        path: "{{patterns.weekly_md}}"
        template_path: "{{patterns.weekly_template}}"
        variables:
          week_data: "{{week_data}}"
          iso_week: "{{iso_week}}"
    - sync_progress:
        source: "{{week_data.completed}}"
        wbs_glob: "{{dirs.stock}}/*/*/3_planning/wbs.md"
        risk_glob: "{{dirs.stock}}/*/*/3_planning/risk_log.md"
    - notify:
        message: |
          ğŸ“’ é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ â†’ {{patterns.weekly_md}}
          ç¢ºèªå¾Œã€Œç¢ºå®šåæ˜ ã—ã¦ã€ã§ Stock ã«ç§»å‹•ã—ã¾ã™

# =========================
# 3. Sync Command (æ‰‹å‹•)
# =========================
sync_with_artifacts:
  trigger:
    - pattern: "(Sync|WBSã¨åŒæœŸ|ãƒªã‚¹ã‚¯ãƒ­ã‚°ã¨åŒæœŸ)"
  steps:
    - parse_daily:
        file: "{{patterns.daily_md}}"
        store_as: done_today
    - sync_wbs:
        completed: "{{done_today}}"
        wbs_glob: "{{dirs.stock}}/*/*/3_planning/wbs.md"
    - sync_risk_log:
        completed: "{{done_today}}"
        risk_glob: "{{dirs.stock}}/*/*/3_planning/risk_log.md"
    - notify:
        message: "WBS / ãƒªã‚¹ã‚¯ãƒ­ã‚°ã¸åŒæœŸã—ã¾ã—ãŸ âœ…"

# =========================
# 4. ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ«ãƒ¼ãƒ«
# =========================
task_management:
  # ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹
  completion:
    # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å½¢å¼
    checkbox:
      - pattern: "- \[ \]"  # æœªå®Œäº†
      - pattern: "- \[x\]"  # å®Œäº†
      - pattern: "- \[-\]"  # ä¿ç•™
      - pattern: "- \[>\]"  # å»¶æœŸ
      - pattern: "- \[!\]"  # ãƒ–ãƒ­ãƒƒã‚¯

    # ã‚¿ã‚¹ã‚¯ã®è¿½åŠ æƒ…å ±ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
    inline_info:
      - pattern: "{comment: .*}"     # ã‚³ãƒ¡ãƒ³ãƒˆ
      - pattern: "{link: .*}"        # é–¢é€£ãƒªãƒ³ã‚¯
      - pattern: "{artifact: .*}"    # æˆæœç‰©
      - pattern: "{time: .*}"        # æ‰€è¦æ™‚é–“
      - pattern: "{blocked_by: .*}"  # ãƒ–ãƒ­ãƒƒã‚¯è¦å› 

    # ã‚¿ã‚¹ã‚¯ã®è¿½åŠ æƒ…å ±ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    block_info:
      - pattern: "<!-- task_info: .* -->"  # ã‚¿ã‚¹ã‚¯æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯
      - pattern: "<!-- task_notes: .* -->"  # ã‚¿ã‚¹ã‚¯ãƒãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯

  # ã‚¿ã‚¹ã‚¯ã®åŒæœŸãƒ«ãƒ¼ãƒ«
  sync:
    # å®Œäº†ã‚¿ã‚¹ã‚¯ã®å‡¦ç†
    on_complete:
      - update_wbs: true           # WBSã‚’æ›´æ–°
      - update_backlog: true       # ãƒãƒƒã‚¯ãƒ­ã‚°ã‚’æ›´æ–°
      - archive_artifacts: true    # æˆæœç‰©ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      - notify_completion: true    # å®Œäº†é€šçŸ¥

    # ä¿ç•™ã‚¿ã‚¹ã‚¯ã®å‡¦ç†
    on_hold:
      - update_wbs: true           # WBSã‚’æ›´æ–°
      - notify_hold: true          # ä¿ç•™é€šçŸ¥
      - schedule_review: 7         # 7æ—¥å¾Œã«å†ãƒ¬ãƒ“ãƒ¥ãƒ¼

    # å»¶æœŸã‚¿ã‚¹ã‚¯ã®å‡¦ç†
    on_defer:
      - update_wbs: true           # WBSã‚’æ›´æ–°
      - reschedule: true           # å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      - notify_defer: true         # å»¶æœŸé€šçŸ¥

  # ã‚¿ã‚¹ã‚¯ã®æ¤œç´¢ãƒ»é›†è¨ˆ
  search:
    - by_status: true              # çŠ¶æ…‹ã§æ¤œç´¢
    - by_priority: true            # å„ªå…ˆåº¦ã§æ¤œç´¢
    - by_due_date: true            # æœŸé™ã§æ¤œç´¢
    - by_project: true             # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ¤œç´¢
    - by_assignee: true            # æ‹…å½“è€…ã§æ¤œç´¢
    - by_artifact: true            # æˆæœç‰©ã§æ¤œç´¢
