# 売上要因分析 — 各グラフの解説

> **対象読者**: 工学系修士（機械学習・統計の専門外）  
> **目的**: 各分析手法の意味と、グラフから読み取れることを理解する

---

## 目次

1. [01_eda_basic.png — 基礎統計の可視化](#1-01_eda_basicpng--基礎統計の可視化)
2. [02_correlation_heatmap.png — 相関行列](#2-02_correlation_heatmappng--相関行列)
3. [03_high_low_comparison.png — 売上カテゴリ別比較](#3-03_high_low_comparisonpng--売上カテゴリ別比較)
4. [04_cluster_optimization.png — クラスタ数の決定](#4-04_cluster_optimizationpng--クラスタ数の決定)
5. [05_cluster_pca.png — 主成分分析による可視化](#5-05_cluster_pcapng--主成分分析による可視化)
6. [06_cluster_radar.png — クラスタ特性のレーダーチャート](#6-06_cluster_radarpng--クラスタ特性のレーダーチャート)
7. [07_feature_importance.png — 要因重要度](#7-07_feature_importancepng--要因重要度)
8. [08_top_features_scatter.png — 主要要因と売上の関係](#8-08_top_features_scatterpng--主要要因と売上の関係)

---

## 1. 01_eda_basic.png — 基礎統計の可視化

![基礎統計の可視化](./01_eda_basic.png)

### 何をしているか
**探索的データ分析（EDA: Exploratory Data Analysis）** の最初のステップとして、データの基本的な分布や傾向を把握しています。

### 4つのグラフの説明

#### 左上：売上の分布（ヒストグラム）
- **横軸**: 日次売上（円）
- **縦軸**: その売上範囲に該当する日数（頻度）
- **赤点線**: 平均値（247,490円）
- **橙点線**: 中央値（209,910円）

**読み取れること**:
- 分布は**右に裾が長い（正の歪度）** → 高売上の日が稀に発生
- 平均 > 中央値 → 高売上日が平均を押し上げている
- 最頻値は15〜20万円付近

#### 右上：曜日別売上分布（箱ひげ図）
- **箱**: 25%点〜75%点（四分位範囲、IQR）
- **箱の中の線**: 中央値
- **ひげ**: 外れ値を除いたデータ範囲
- **○印**: 外れ値

**読み取れること**:
- **土日（オレンジ）は平日（青）より売上が低い** → 意外な発見
- 金曜日の中央値が最も高い
- 週末は分散が大きい（バラつきが大きい）

#### 左下：売上の時系列推移
- 2年間の日次売上をプロット
- 2025年中盤以降、売上のボラティリティ（変動幅）が増加している傾向

#### 右下：客数 vs 売上（散布図）
- **相関係数 r = 0.923** → 非常に強い正の相関
- 回帰直線（赤点線）の傾きから、**客1人あたり約1,500〜1,700円**の売上貢献と推定

**数学的補足**:
相関係数は -1 ≤ r ≤ 1 の範囲を取り、|r| > 0.7 で「強い相関」と判断される。

---

## 2. 02_correlation_heatmap.png — 相関行列

![相関行列](./02_correlation_heatmap.png)

### 何をしているか
各特徴量（変数）間の**ピアソン相関係数**を計算し、色で可視化しています。

### 読み方
- **赤系**: 正の相関（一方が増えると他方も増える）
- **青系**: 負の相関（一方が増えると他方は減る）
- **白**: 無相関（関係がない）
- **数値**: 相関係数（-1〜+1）

### 主要な発見

| 関係 | 相関係数 | 解釈 |
|------|----------|------|
| total_sales ↔ total_customers | 0.92 | 客数と売上は強く連動 |
| total_sales ↔ alcohol_ratio | 0.76 | アルコール比率が高い日は売上も高い |
| alcohol_ratio ↔ topping_ratio | 0.87 | アルコールとトッピングは同時に注文される傾向 |
| lunch_ratio ↔ dinner_ratio | -0.42 | ランチとディナーはトレードオフ |
| lunch_ratio ↔ peak_concentration | 0.90 | ランチ比率が高い日は12-14時に集中 |

### 注意点
- 相関は**因果関係を意味しない**（「アルコールを売れば売上が上がる」とは限らない）
- 背後に**共通の要因（交絡因子）** がある可能性（例：「夜営業の日」がアルコールも売上も高める）

---

## 3. 03_high_low_comparison.png — 売上カテゴリ別比較

![売上カテゴリ別比較](./03_high_low_comparison.png)

### 何をしているか
全662日を売上で3分割（低・中・高）し、各カテゴリの特徴を箱ひげ図で比較しています。

### 6つの比較軸

| グラフ | 発見 |
|--------|------|
| **客単価** | 高売上日は中央値が約1,700円、低売上日は約1,200円 → **500円の差** |
| **客数** | 高売上日は200人超、低売上日は100人程度 → **2倍の差** |
| **アルコール比率** | 低売上日は**ほぼ0%**、高売上日は分布が広い |
| **ランチ比率** | 売上カテゴリによる差は小さい |
| **1組あたり客数** | 高売上日のほうがやや高い（グループ客が多い）|
| **平均注文商品数** | 大きな差はない |

### 示唆
- **客数**と**客単価**の両方が高売上に寄与
- 特に**アルコール**の有無が明確な分岐点

---

## 4. 04_cluster_optimization.png — クラスタ数の決定

![クラスタ数の決定](./04_cluster_optimization.png)

### 何をしているか
**K-means法**（クラスタリング手法）で使用するクラスタ数 k を決めるための診断グラフです。

### K-means法とは
n個のデータを k 個のグループに分ける手法。各データは**最も近い中心点（セントロイド）** に割り当てられます。

目的関数（最小化対象）:
$$
J = \sum_{i=1}^{k} \sum_{x \in C_i} ||x - \mu_i||^2
$$
ここで $\mu_i$ はクラスタ $C_i$ の中心点。

### 左グラフ：エルボー法（Elbow Method）
- **縦軸 Inertia**: クラスタ内の分散の総和（= 目的関数 J）
- クラスタ数を増やすと必ず減少するが、**「肘」のように折れ曲がる点**が適切な k

**この結果**: 明確な肘はなく、k=3〜4あたりで緩やかになっている

### 右グラフ：シルエットスコア
- **シルエット係数**: 各データ点について「自クラスタ内の平均距離」と「最も近い他クラスタまでの距離」の比を計算
- 範囲は -1 〜 +1、**高いほどクラスタが良く分離**されている

$$
s(i) = \frac{b(i) - a(i)}{\max(a(i), b(i))}
$$

- $a(i)$: 同じクラスタ内の平均距離
- $b(i)$: 最近傍クラスタまでの平均距離

**この結果**: k=3 でシルエットスコアが最大（約0.42） → **k=3 を採用**

---

## 5. 05_cluster_pca.png — 主成分分析による可視化

![主成分分析による可視化](./05_cluster_pca.png)

### 何をしているか
9次元の特徴量空間を**主成分分析（PCA: Principal Component Analysis）** で2次元に圧縮し、クラスタを可視化しています。

### PCAとは
高次元データを、分散が最大となる方向（主成分）に射影して次元削減する手法。

- **第1主成分（PC1）**: データの分散を最も説明する軸（寄与率 40.8%）
- **第2主成分（PC2）**: PC1と直交し、次に分散を説明する軸（寄与率 23.0%）

合計で元の分散の約64%を2次元で表現できています。

### 左グラフ：クラスタ分布
- 色がクラスタを表す
- **紫（クラスタ0）**: 左下に集中 → 低売上型
- **緑（クラスタ1）**: 左上に分布 → 中売上型（ランチ中心）
- **黄（クラスタ2）**: 右上に分布 → 高売上型

3つのクラスタが**比較的明確に分離**されていることがわかります。

### 右グラフ：売上分布
- 同じPCA空間で、色を「売上」で表示
- **PC1方向（右へ）行くほど売上が高い** → PC1は「売上軸」に近い解釈が可能

---

## 6. 06_cluster_radar.png — クラスタ特性のレーダーチャート

![クラスタ特性のレーダーチャート](./06_cluster_radar.png)

### 何をしているか
各クラスタの特徴を7つの軸で比較しています。値は0〜1に正規化されており、**形状の違い**でクラスタの性質を直感的に把握できます。

### 各軸の意味

| 軸 | 説明 |
|----|------|
| 客単価 | 1人あたり売上（円） |
| 1組あたり客数 | 伝票1枚あたりの客数（グループサイズ） |
| ランチ比率 | 11:00-14:00の売上比率 |
| ディナー比率 | 17:00-21:00の売上比率 |
| アルコール比率 | アルコール売上の比率 |
| 平均注文商品数 | 1伝票あたりの商品数 |
| ピーク集中度 | 12-14時への売上集中度 |

### クラスタの特徴

| クラスタ | 形状の特徴 | 解釈 |
|----------|------------|------|
| **0（紫）** | 1組あたり客数が高い、平均注文商品数が多い | 週末のファミリー客？ |
| **1（緑）** | ランチ比率・ピーク集中度が高い | 平日ランチ中心のビジネス客 |
| **2（黄）** | 客単価・ディナー比率・アルコール比率が高い | **高単価のディナー客** |

---

## 7. 07_feature_importance.png — 要因重要度

![要因重要度](./07_feature_importance.png)

### 何をしているか
**ランダムフォレスト回帰**で売上を予測し、各特徴量の**重要度（Feature Importance）** を算出しています。

### ランダムフォレストとは
複数の**決定木（Decision Tree）** を並列に学習させ、その予測を平均するアンサンブル手法。

- 決定木は「もし X > 閾値 なら...」という分岐ルールの集合
- 各分岐で使われる特徴量が「重要」と判断される
- 重要度は「その特徴量で分岐した際の不純度の減少量」の平均

### 結果の解釈

| 順位 | 特徴量 | 重要度 | 解釈 |
|------|--------|--------|------|
| 1 | alcohol_ratio | 0.549 | **売上予測の54.9%を説明** |
| 2 | total_customers | 0.250 | 客数が次に重要 |
| 3 | topping_ratio | 0.149 | トッピング注文も寄与 |
| 4以下 | その他 | <0.03 | 相対的に影響が小さい |

### 注意点

1. **重要度 ≠ 因果関係**
   - 「アルコールを売れば売上が上がる」ではない
   - 「アルコールがよく出る日は、他の要因も重なって高売上になりやすい」

2. **相関の高い変数間の分配**
   - total_customers と slip_count は相関0.98
   - 重要度が分散され、個別の値は過小評価される可能性

3. **非線形関係も捕捉**
   - 線形相関だけでは見えない「閾値効果」なども反映される

---

## 8. 08_top_features_scatter.png — 主要要因と売上の関係

![主要要因と売上の関係](./08_top_features_scatter.png)

### 何をしているか
重要度上位4つの特徴量について、売上との**散布図**と**回帰直線**を描いています。

### 各グラフの解説

#### slip_count vs 売上（相関: 0.872）
- **伝票数**と売上の関係
- ほぼ線形の関係 → 「来店組数 × 平均客単価」で売上が決まる構造

#### topping_ratio vs 売上（相関: 0.735）
- **特徴的なパターン**: topping_ratio = 0 の日が縦に並ぶ
- トッピングが0%の日は売上の上限が約25万円
- トッピングが出る日は**売上のバラつきが大きいが、高売上の可能性**

#### total_customers vs 売上（相関: 0.923）
- **最も線形性が高い**
- 傾き ≈ 1,500円/人 → 客単価の推定値と整合

#### alcohol_ratio vs 売上（相関: 0.762）
- **2つのグループが見える**:
  - alcohol_ratio = 0: 売上は0〜25万円に集中（低〜中売上）
  - alcohol_ratio > 0: 売上は20〜90万円に分布（中〜高売上）
- **閾値効果**: アルコール比率が「ある/なし」で売上の分布が大きく異なる

### 重要な示唆

この4つの散布図から、売上を分ける**2つの「質的な違い」** が見えます：

1. **アルコールが出る日 vs 出ない日**（営業形態の違い？）
2. **客数が多い日 vs 少ない日**（集客施策の成否？）

単純な線形回帰よりも、**「どちらの営業パターンか」を分類**してから予測するほうが精度が上がる可能性があります。

---

## まとめ：分析の流れと各手法の役割

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: EDA（探索的データ分析）                              │
│  ├── ヒストグラム: 分布の形状を把握                           │
│  ├── 箱ひげ図: グループ間の比較                               │
│  └── 散布図: 2変数間の関係を視覚化                            │
├─────────────────────────────────────────────────────────────┤
│  Step 2: 相関分析                                            │
│  └── 相関行列: 全変数間の関係を俯瞰                           │
├─────────────────────────────────────────────────────────────┤
│  Step 3: クラスタリング（教師なし学習）                        │
│  ├── K-means: データを k 個のグループに分類                    │
│  ├── エルボー法/シルエット: 最適な k を決定                    │
│  ├── PCA: 高次元データを2Dで可視化                            │
│  └── レーダーチャート: 各クラスタの特徴を比較                  │
├─────────────────────────────────────────────────────────────┤
│  Step 4: 重要度分析（教師あり学習）                            │
│  ├── ランダムフォレスト: 売上を予測するモデルを構築            │
│  └── Feature Importance: どの変数が予測に寄与するか             │
└─────────────────────────────────────────────────────────────┘
```

---

## 用語集

| 用語 | 説明 |
|------|------|
| EDA | Exploratory Data Analysis（探索的データ分析） |
| 相関係数 | 2変数間の線形関係の強さ（-1〜+1） |
| K-means | データを k 個のクラスタに分ける手法 |
| Inertia | クラスタ内分散の総和（小さいほど凝集） |
| シルエットスコア | クラスタの分離度合いの指標（高いほど良い） |
| PCA | 主成分分析。次元削減手法 |
| ランダムフォレスト | 決定木のアンサンブル学習手法 |
| Feature Importance | 各特徴量の予測への貢献度 |

---

*生成日: 2026-01-21*
