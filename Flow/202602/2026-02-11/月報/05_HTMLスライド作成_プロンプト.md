# 05: HTMLスライド作成（フェーズ5）— D3.js + HTML月報スライド（AI手順書）

> 目的/更新履歴は `00_月報作成_統合プロンプト.md` に集約済み。  
> 本ファイルは **AIが参照して実行できる手順** のみを記載します。

---

## 入力（前フェーズから渡される前提）

- `{運営会社コード}`（例: `BFA`）
- `{対象月}`（例: `2026-01`）
- `{month_slug}`（例: `202601`）
- `{出力ディレクトリ}`（例: `./2_output/BFA/2_output_202601`）
- `{スライド構成}`（フェーズ3+4で完成済みの `月報スライド構成案.md`）

---

## 参照

- **必須入力**: `{スライド構成}`（Markdownのスライド構成案。全スライドのタイトル・データ表・メッセージが含まれる）
- **グラフライブラリ**: D3.js v7（CDN: `https://d3js.org/d3.v7.min.js`）

---

## 手順（AIが実行）

### 1) スライド構成案の読み込みと確認

- `{スライド構成}` を全文読み込む
- スライド総数を確認し、控える（例: 34枚）
- **スライド枚数は構成案に厳密に従う**（追加・省略は一切不可）
- ファイル名: `{month_slug}_{運営会社コード}_月次報告資料.html`
  - 例: `202601_BFA_月次報告資料.html`

### 2) HTML構造の設計

#### 2.1 基本構造

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{店舗名} 月次営業報告 — {対象月}</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* 全スタイルをここに記述（外部CSS不使用） */
  </style>
</head>
<body>
  <!-- スライド1 -->
  <div class="slide" id="slide-1">
    ...
  </div>

  <!-- スライド2 -->
  <div class="slide" id="slide-2">
    ...
  </div>

  <!-- 以下、全スライド分 -->

  <script>
    // D3.jsグラフ描画スクリプトをここに記述
  </script>
</body>
</html>
```

**重要**: 単一HTMLファイルで完結させる（外部CSS/JSファイルは使用しない。D3.js CDNのみ外部参照）

#### 2.2 PDF改ページの実装（最重要）

各スライドが印刷/PDF出力時に1ページとして分離されるよう、以下のCSSを必ず適用する:

```css
@media print {
  body {
    margin: 0;
    padding: 0;
  }
  .slide {
    page-break-after: always;
    page-break-inside: avoid;
    break-after: page;
    break-inside: avoid;
  }
  .slide:last-child {
    page-break-after: auto;
  }
}

/* 画面表示用 */
@media screen {
  .slide {
    margin: 0 auto 40px auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
  }
}
```

#### 2.3 スライドサイズ

- **16:9** アスペクト比
- 固定サイズ: `width: 1280px; height: 720px;`
- `overflow: hidden;` でスライドからのはみ出しを防止

```css
.slide {
  width: 1280px;
  height: 720px;
  position: relative;
  overflow: hidden;
  background: #ffffff;
  font-family: 'Helvetica Neue', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
}
```

---

### 3) デザイン方針

#### 3.1 カラーパレット

| 用途 | 色名 | HEXコード | 使い方 |
|:---|:---|:---|:---|
| **ヘッダー背景** | ダークネイビー | `#1E3A5F` | スライドヘッダーの帯、タイトル背景 |
| **ポジティブ（増加・好調）** | グリーン | `#22C55E` | 前月比プラス、好調週ハイライト |
| **ネガティブ（減少・不調）** | レッド | `#EF4444` | 前月比マイナス、不調週ハイライト |
| **注目・変化** | オレンジ | `#F97316` | 吹き出し、矢印、アノテーション背景 |
| **当月データ** | メインブルー | `#3B82F6` | 棒グラフ・折れ線グラフの当月系列 |
| **前月/比較データ** | グレー | `#94A3B8` | 比較用の棒グラフ・折れ線 |
| **スライド背景** | ライトグレー | `#F8FAFC` | スライド全体の背景 |
| **テキスト（本文）** | ダークグレー | `#334155` | 本文テキスト |
| **テキスト（見出し）** | ネイビー | `#1E293B` | 見出し、太字テキスト |

#### 3.2 タイポグラフィ（フォントサイズ階層）

| 要素 | フォントサイズ | ウェイト | 用途 |
|:---|:---|:---|:---|
| スライドタイトル | `28px` | `700` | 各スライドの大見出し |
| KPI大数字 | `48px` 〜 `64px` | `800` | 売上金額、主要指標の数値 |
| KPI比較数字 | `24px` 〜 `32px` | `700` | 前月比・前年比のパーセンテージ |
| サブ見出し | `20px` | `600` | セクション小見出し |
| 本文テキスト | `16px` | `400` | 説明文、コメント |
| 表セル | `14px` | `400` | テーブルのデータ |
| 注釈・キャプション | `12px` | `400` | グラフ軸ラベル、出典 |
| **アノテーション** | `14px` 〜 `18px` | `700` | グラフ上の吹き出し内テキスト |

**強調ルール**:
- **最も伝えたい数字**はフォントサイズを周囲の **2倍以上** にし、太字 + 色で強調する
- プラスの変化は `#22C55E`（グリーン）、マイナスは `#EF4444`（レッド）
- 比較数字の前に `▲`（増加）/ `▼`（減少）を付ける

#### 3.3 レイアウトパターン

スライドの内容に応じて以下のパターンを使い分ける:

| パターン | 構成 | 使用するスライド |
|:---|:---|:---|
| **タイトルスライド** | 中央揃え大見出し + サブタイトル | スライド1 |
| **KPIカード** | 3〜5個のカードを横並び | スライド2, 6 |
| **グラフ + コメント** | 左2/3にグラフ、右1/3にコメント | スライド3-5, 7, 17, 19, 21 |
| **比較表** | ヘッダー付きテーブル | スライド8-15, 23-24 |
| **箇条書き** | 3〜5点の要点 + アイコン | スライド18, 20, 22, 25-27 |
| **施策一覧** | 2カラム表 | スライド28-30 |
| **日報引用** | 引用ブロック並べ | 日報スライド |

---

### 4) D3.jsグラフの描画ルール

#### 4.1 グラフ種別の使い分け

| スライド | グラフ種別 | 説明 |
|:---|:---|:---|
| 売上推移（月次トレンド） | **折れ線グラフ** | 直近6ヶ月の売上推移。当月のドットを大きく強調 |
| 客数推移（月次トレンド） | **折れ線グラフ** | 同上、客数版 |
| 客単価推移（月次トレンド） | **折れ線グラフ** | 同上、客単価版 |
| 週別概況 | **棒グラフ** | 月内の各週の日平均売上。好調/不調週に色分け |
| 曜日別日平均売上 | **棒グラフ（グループ）** | 当月 vs 前月の曜日別比較 |
| 時間帯別月間売上 | **横棒グラフ** | 時間帯バケット別の売上構成 |
| カテゴリ別売上構成比 | **ドーナツチャート** | カテゴリ別の構成比（上位5 + その他） |
| 深掘り: 曜日別比較 | **棒グラフ（グループ）** | 好調週 vs 不調週の曜日別比較 |
| 深掘り: 時間帯別比較 | **棒グラフ（グループ）** | 好調週 vs 不調週の時間帯別比較 |

#### 4.2 D3.jsアノテーション・強調のルール（最重要）

グラフの「どこを見るべきか」を明確にするために、以下の装飾を **必ず** 適用する:

##### a) 当月・対象データのハイライト
- 折れ線グラフの当月ドットは **半径を他の2倍（r=8）** にし、`#3B82F6` で塗る
- 棒グラフの好調週は `#22C55E`、不調週は `#EF4444` で塗る
- それ以外の棒は `#94A3B8`（グレー）

##### b) 吹き出し（コールアウト）アノテーション
最も注目すべきデータポイントに、D3.jsで吹き出しを追加する:

```javascript
// 吹き出しの実装パターン
function addCallout(svg, x, y, text, options = {}) {
  const {
    bgColor = '#FFF7ED',      // 薄いオレンジ背景
    borderColor = '#F97316',   // オレンジ枠
    textColor = '#1E293B',     // ダークテキスト
    fontSize = '14px',
    fontWeight = '700',
    arrowTarget = null         // 矢印の先端座標 {x, y}
  } = options;

  const g = svg.append('g').attr('class', 'callout');

  // 矢印線（データポイントへの引き出し線）
  if (arrowTarget) {
    g.append('line')
      .attr('x1', x).attr('y1', y)
      .attr('x2', arrowTarget.x).attr('y2', arrowTarget.y)
      .attr('stroke', borderColor)
      .attr('stroke-width', 2)
      .attr('stroke-dasharray', '4,3');

    // 矢印の三角
    g.append('polygon')
      .attr('points', arrowHead(x, y, arrowTarget.x, arrowTarget.y))
      .attr('fill', borderColor);
  }

  // 背景ボックス
  const padding = { x: 12, y: 8 };
  const textEl = g.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', fontSize)
    .attr('font-weight', fontWeight)
    .attr('fill', textColor)
    .text(text);
  const bbox = textEl.node().getBBox();

  g.insert('rect', 'text')
    .attr('x', bbox.x - padding.x)
    .attr('y', bbox.y - padding.y)
    .attr('width', bbox.width + padding.x * 2)
    .attr('height', bbox.height + padding.y * 2)
    .attr('rx', 6)
    .attr('fill', bgColor)
    .attr('stroke', borderColor)
    .attr('stroke-width', 1.5);
}
```

##### c) 増減矢印の表示
前月比・前年比の数値の横に、SVGの矢印アイコンを付ける:

```javascript
// ▲ 増加（グリーン）
function upArrow(svg, x, y) {
  svg.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', '18px')
    .attr('fill', '#22C55E')
    .attr('font-weight', '800')
    .text('▲');
}

// ▼ 減少（レッド）
function downArrow(svg, x, y) {
  svg.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', '18px')
    .attr('fill', '#EF4444')
    .attr('font-weight', '800')
    .text('▼');
}
```

##### d) 基準線・目標ライン
月平均や前年値などの基準値を、破線で水平に引く:

```javascript
// 基準線
svg.append('line')
  .attr('x1', marginLeft).attr('x2', width - marginRight)
  .attr('y1', yScale(avgValue)).attr('y2', yScale(avgValue))
  .attr('stroke', '#F97316')
  .attr('stroke-width', 1.5)
  .attr('stroke-dasharray', '6,4');

svg.append('text')
  .attr('x', width - marginRight + 4)
  .attr('y', yScale(avgValue) + 4)
  .attr('font-size', '12px')
  .attr('fill', '#F97316')
  .attr('font-weight', '600')
  .text('月平均');
```

##### e) フォントサイズによる強調
グラフ上の数値ラベルで、最大値・最小値・注目値のフォントサイズを大きくする:

```javascript
// 通常のデータラベル
bars.append('text')
  .text(d => `¥${d.value.toLocaleString()}`)
  .attr('font-size', d => d.isHighlight ? '16px' : '12px')
  .attr('font-weight', d => d.isHighlight ? '700' : '400')
  .attr('fill', d => d.isHighlight ? '#1E293B' : '#64748B');
```

#### 4.3 グラフ共通設定

```javascript
// 全グラフ共通のマージン
const margin = { top: 40, right: 40, bottom: 40, left: 60 };

// SVGサイズ（スライド内での描画領域）
// グラフ+コメントパターンの場合: 幅800px前後
// フルワイドの場合: 幅1100px前後

// 軸ラベルのフォント
const axisStyle = {
  fontSize: '12px',
  fontFamily: "'Helvetica Neue', 'Hiragino Kaku Gothic ProN', sans-serif",
  color: '#64748B'
};

// グリッド線
// Y軸のグリッド線は薄いグレー破線で表示
svg.append('g')
  .attr('class', 'grid')
  .selectAll('line')
  .data(yScale.ticks(5))
  .join('line')
  .attr('x1', margin.left)
  .attr('x2', width - margin.right)
  .attr('y1', d => yScale(d))
  .attr('y2', d => yScale(d))
  .attr('stroke', '#E2E8F0')
  .attr('stroke-dasharray', '3,3');
```

---

### 5) スライド種別ごとの実装ガイド

#### 5.1 タイトルスライド（スライド1）

```html
<div class="slide slide-title" id="slide-1">
  <div class="title-bg">
    <!-- ダークネイビー背景にロゴ的なアクセント -->
  </div>
  <h1 class="main-title">{店舗名}</h1>
  <h2 class="sub-title">月次営業報告</h2>
  <p class="period">{対象月}（{開始日} 〜 {終了日}）</p>
</div>
```

CSSイメージ:
```css
.slide-title {
  background: linear-gradient(135deg, #1E3A5F 0%, #0F172A 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #fff;
}
.main-title { font-size: 48px; font-weight: 800; }
.sub-title { font-size: 28px; font-weight: 400; margin-top: 12px; opacity: 0.9; }
.period { font-size: 18px; margin-top: 24px; opacity: 0.7; }
```

#### 5.2 KPIカードスライド（スライド2, 6）

- KPIを3〜5個のカードとして横並びに配置
- 各カードに: **指標名**（小さく） → **実績値**（大きく太字） → **前月比/前年比**（色付き）
- 前月比がプラスなら `#22C55E` + `▲`、マイナスなら `#EF4444` + `▼`

```html
<div class="kpi-card">
  <span class="kpi-label">月間売上</span>
  <span class="kpi-value">¥2,850,000</span>
  <span class="kpi-change positive">▲ 前月比 +12.3%</span>
</div>
```

#### 5.3 折れ線グラフスライド（スライド3-5）

- D3.jsで折れ線グラフを描画
- 当月のデータポイントにドットを大きく表示（`r=8`）
- 当月ドットの上に **吹き出しアノテーション** でKPI値を表示
- 前年同月のデータポイントがあれば、薄い破線で別系列として表示
- 右1/3のコメント欄に「トレンド読み取り」を記載

#### 5.4 棒グラフスライド（週別概況、曜日別）

- 好調週/好調曜日は `#22C55E`、不調は `#EF4444`、その他は `#3B82F6`
- 月平均の基準線を破線で表示
- 好調/不調の棒にのみ **吹き出しアノテーション** を配置
- 好調/不調の棒のデータラベルは **フォントサイズ16px・太字**、その他は **12px・通常**

#### 5.5 ドーナツチャート（カテゴリ別構成比）

- D3.jsの `d3.arc()` で描画
- 上位3カテゴリは個別色、残りは `#E2E8F0`（ライトグレー）でまとめる
- 最大カテゴリのセグメントを `outerRadius + 10` で少し外に突き出す
- 中央に「合計金額」を大きく表示

#### 5.6 表スライド（商品TOP15、深掘り比較表）

- HTML `<table>` でスタイリング
- ヘッダー行は `#1E3A5F` 背景 + 白文字
- 交互行に薄い背景色（`#F8FAFC`）
- 最大値のセルは **太字 + 色変更** で強調
- 増減列はプラス/マイナスで色分け

#### 5.7 日報引用スライド

- 引用ブロック（`blockquote`）を並べる
- 左端に `3px solid #3B82F6` のボーダー
- 日付・氏名は太字、引用テキストは通常ウェイト
- グラフは不要（テキストのみ）

#### 5.8 施策一覧スライド

- 2カラムの表形式
- 施策名は太字、「狙い」列は通常ウェイト
- 行ごとに薄い背景色の交互表示

---

### 6) データの正確性（最重要）

#### 表データの完全一致
- スライドに表を含める場合、表内の文字・数値は `{スライド構成}` の記載と **1文字も違わず一致** させること
- 構成案の表をスライドに転記する際は、必ずセル単位で照合すること

#### 固有名詞の正確性
- 商品名・カテゴリ名・店舗名などの固有名詞は、表記揺れ・誤字・脱字が **絶対にない** よう、構成案の記載を正確に転記すること
- 以下のようなミスは不可:
  - 英字の大文字/小文字の違い（例: `Hojicha Negroni` → `Hojicha negroni` は NG）
  - 漢字/ひらがなの表記揺れ（例: `山葵と梨のスマッシュ` → `わさびと梨のスマッシュ` は NG）
  - 中点・スペースの有無（例: `ジャパニーズカクテル` → `ジャパニーズ・カクテル` は NG）
  - カテゴリ名の省略（例: `ウイスキー（ハイボール・ボトル・オリジナル）` → `ウイスキー（HB・ボトル）` は NG）

#### 数値の正確性
- 金額・パーセンテージ・人数などは構成案の値をそのまま使用する
- 丸め・再計算・独自の集計は行わない

#### D3.jsグラフのデータ
- グラフに使用するデータは、構成案の「グラフ用データ」表から正確に転記する
- JavaScript内でデータを `const data = [...]` として直接記述する（外部JSONファイルは使用しない）

---

### 7) 出力形式

#### 出力ファイル
- `{出力ディレクトリ}/{month_slug}_{運営会社コード}_月次報告資料.html`
  - 例: `./2_output/BFA/2_output_202601/202601_BFA_月次報告資料.html`

#### PDF出力方法（ユーザーが実行）
1. HTMLファイルをブラウザ（Chrome推奨）で開く
2. `Ctrl+P`（`Cmd+P`）で印刷ダイアログを開く
3. 「送信先」→「PDFとして保存」
4. レイアウト：**横向き**
5. 余白：**なし**
6. 背景のグラフィック：**ON**

---

### 8) 注意事項

1. **スライド枚数厳守**: 構成案のスライド枚数を1枚たりとも変えないこと。スライドの統合・分割は不可

2. **テキスト最小化**: 忙しいオーナーが一目で分かるデザインにする。長文は禁止

3. **グラフの装飾は必ず実施**:
   - すべてのグラフに **最低1つのアノテーション（吹き出し）** を付ける
   - 好調/不調の色分けは **必ず** 行う
   - 最大値・最小値のデータラベルは **フォントサイズと太さで強調**
   - 基準線（月平均、前年値など）を **破線で表示**

4. **「達成・未達成」の使い方**
   - 「達成」「未達」「達成率」は **明確な目標値に対して** 使う言葉。目標値が設定されている場合のみ使用する
   - 前年同月との比較は目標ではない。「達成率」ではなく **「前年比+◯%」「前年比-◯%」** と表現する
   - 前月との比較も同様。「達成率◯%」ではなく **「前月比+◯%」「前月の◯割水準」** 等と表現する

5. **スライド上の表記は日本語を使う**
   - カタカナ英語・英語表記はなるべく避け、日本語で表現する
   - 特に以下のような表現は使わない:
     - NG: 「サイズ」→ OK: 「規模」「人数」
     - NG: 「ケース」→ OK: 「件」「事例」
     - NG: 「カウント」→ OK: 「件数」「数」
     - NG: 「セールス」→ OK: 「売上」
     - NG: 「トップ15」→ OK: 「上位15商品」
     - NG: 「Win / Loss」→ OK: 「強み / 課題」
   - 固有名詞（商品名・店舗名・サービス名など）はそのまま英語表記でOK
   - 一般に広く使われ日本語に置き換えると不自然なもの（KPI、SNS等）は許容する

6. **単一HTMLファイル完結**
   - CSSは `<style>` タグ内、JSは `<script>` タグ内にすべて記述
   - 外部参照は D3.js CDN のみ
   - 画像ファイルの外部参照は不可（SVGインラインまたはCSSで代替）

7. **ブラウザ互換性**
   - Chrome / Edge / Firefox の最新版で正しく表示されること
   - PDF出力時に全グラフが正しく描画されること

---

## セルフチェック（作成後に必ず実行）

以下の全項目を確認してからファイルを保存すること:

- [ ] スライド枚数が構成案と一致しているか
- [ ] 各スライドのタイトルが構成案と一致しているか
- [ ] 表内の文字・数値が構成案と完全に一致しているか（1セルずつ照合）
- [ ] 商品名・カテゴリ名に表記揺れがないか（構成案と1文字ずつ比較）
- [ ] **各グラフに最低1つのアノテーション（吹き出し or 矢印）が付いているか**
- [ ] **好調/不調の色分けが正しく適用されているか**（グリーン/レッド）
- [ ] **最大値・最小値のフォントサイズが周囲より大きいか**
- [ ] **基準線（月平均・前年値）が破線で表示されているか**
- [ ] PDFで改ページが各スライドの境界で正しく発生するか
- [ ] D3.jsのグラフがブラウザで正しく描画されるか
- [ ] HTMLファイルが単体で開けるか（外部ファイル依存なし、D3.js CDN除く）

---

## チェックリスト（フェーズ5完了条件）
- `{出力ディレクトリ}` にHTMLファイルが保存されている
- ブラウザで開いてすべてのスライドが正しく表示される
- D3.jsグラフがすべて描画されている
- PDF出力時に1スライド=1ページで分離される
- アノテーション・色分け・フォント強調が全グラフに適用されている
