# Uレジ FOOD 汎用検索 CSV出力手順書

## 設定変数

```yaml
# 期間設定
開始日: 20250801
終了日: 20251031

# 店舗情報
店舗コード: 001
店舗名: 麻布しき 旗の台店
店舗表記: "001:麻布しき 旗の台店"
```

---

## 概要

本手順書は、Uレジ FOODシステムから売上データをCSV形式で出力するための詳細な手順を記載しています。

## 前提条件

- Uレジ FOODシステムにログイン済みであること
- 初期画面：お知らせ一覧ページ（`https://u07.u-regi.com/information/C_information/information_list`）

---

## 手順

### ステップ1: 帳票管理画面への移動

#### 操作
1. 画面左側のサイドメニューから「帳票管理」をクリック
2. 新しいページが読み込まれるまで2秒待機

#### 技術的詳細
- **要素**: リンクまたはジェネリック要素
- **テキスト**: `"帳票管理"`
- **遷移先URL**: `https://u07.u-regi.com/portal/C_portal/ledger_reference_station`

#### 確認方法
- ページタイトルが「Uレジ FOOD」に変わる
- 画面中央に「基本帳票を見る」「店舗分析帳票を見る」などのセクションが表示される

---

### ステップ2: 汎用検索画面への移動

#### 操作
1. 「店舗分析帳票を見る」セクション内の「汎用検索」ボタンをクリック
2. 新しいタブが開くまで2秒待機

#### 技術的詳細
- **要素**: `button`
- **type**: `"button"`
- **テキスト**: `"汎用検索"`
- **遷移先URL**: `https://u07.u-regi.com/general_purpose_search2/C_general_purpose_search/purpose_search_list`

#### 確認方法
- 新しいタブが開く
- ページタイトルが「汎用検索」に変わる
- 「データの選択」セクションが表示される

---

### ステップ3: データ種別の選択

#### 操作
1. 「データ」ドロップダウンを選択
2. `form_input`ツールを使用して値を設定：`"売上データ(伝票 + 伝票明細)"`
3. 2秒待機してページの更新を待つ

#### 技術的詳細
- **要素**: `combobox`
- **デフォルト値**: `"売上データ(伝票)"`
- **設定値**: `"売上データ(伝票 + 伝票明細)"`
- **重要**: クリック方式ではなく、`form_input`ツールを使用すること

#### コマンド例
```python
form_input(ref="ref_21", value="売上データ(伝票 + 伝票明細)", tabId=<TAB_ID>)
```

#### 確認方法
- ドロップダウンの表示が「売上データ(伝票 + 伝票明細)」に変わる
- 項目一覧が更新され、「H.」で始まる項目と「D.」で始まる項目が表示される

---

### ステップ4: 店舗の選択

#### 操作
- 「店舗」セクションで「**{{店舗表記}}**」のチェックボックスをチェック

#### 技術的詳細
- **要素**: `checkbox`
- **label内のテキスト**: `"001:麻布しき 旗の台店"`
- `form_input`ツールで値を`true`に設定

#### 検索方法
```python
find(query="001:麻布しき 旗の台店", tabId=<TAB_ID>)
```

#### 確認方法
- チェックボックスにチェックマークが表示される

---

### ステップ5: 期間の設定

#### 操作
1. 「期間」セクションの開始日フィールドに「**{{開始日}}**」を入力
2. 終了日フィールドに「**{{終了日}}**」を入力

#### 技術的詳細
- **要素**: `textbox (type="number")`
- **placeholder**: `"yyyymmdd"`
- **フィールド数**: 2つ（開始日と終了日）
- `form_input`ツールを使用

#### コマンド例
```python
form_input(ref="ref_79", value=20250801, tabId=<TAB_ID>)
form_input(ref="ref_81", value=20251031, tabId=<TAB_ID>)
```

#### 注意
- 数値として入力（引用符なし）
- 形式: `YYYYMMDD`（8桁）

---

### ステップ6: 項目の選択

#### 操作
以下の項目のチェックボックスを順番にチェックする

#### チェック項目リスト

##### ヘッダー項目（H.で始まる項目）

| 項目名 | 検索クエリ |
|--------|------------|
| H.店舗 | `find(query="H.店舗 checkbox", tabId=<TAB_ID>)` |
| H.伝票番号 | `find(query="H.伝票番号 checkbox", tabId=<TAB_ID>)` |
| H.伝票処理日 | `find(query="H.伝票処理日 checkbox", tabId=<TAB_ID>)` |
| H.曜日 | `find(query="H.曜日 checkbox", tabId=<TAB_ID>)` |
| H.客数（合計） | `find(query="H.客数（合計） checkbox", tabId=<TAB_ID>)` |

##### 明細項目（D.で始まる項目）

| 項目名 | 検索クエリ |
|--------|------------|
| D.商品カテゴリ1 | `find(query="D.商品カテゴリ1 checkbox", tabId=<TAB_ID>)` |
| D.商品カテゴリ2 | `find(query="D.商品カテゴリ2 checkbox", tabId=<TAB_ID>)` |
| D.価格 （商品価格） | `find(query="D.価格 checkbox", tabId=<TAB_ID>)` |
| D.数量 | `find(query="D.数量 checkbox", tabId=<TAB_ID>)` |
| D.オーダー日時 | `find(query="D.オーダー日時 checkbox", tabId=<TAB_ID>)` |
| D.オーダーステータス | `find(query="D.オーダーステータス checkbox", tabId=<TAB_ID>)` |

#### 技術的詳細
- 各項目は`row`要素内に`label > checkbox`の構造
- `find`ツールで項目を特定後、`read_page`で構造を確認
- チェックボックスの`ref`を特定して`form_input(ref="ref_XXX", value=true)`でチェック

#### 手順の流れ
1. `find`ツールで項目を検索
2. 返された`ref_id`を使って`read_page`で詳細構造を確認
3. `checkbox`要素の`ref`を特定
4. `form_input`でチェックボックスを`true`に設定
5. 次の項目へ

#### 例（H.店舗の場合）
```python
# 1. 検索
find(query="H.店舗 checkbox", tabId=826584902) 
# → 結果: ref_671が見つかる

# 2. 構造確認
read_page(tabId=826584902, ref_id="ref_671", depth=2) 
# → 構造確認: checkbox ref_673を発見

# 3. チェック実行
form_input(ref="ref_673", value=true, tabId=826584902) 
# → チェック完了
```

#### 注意事項
- ページが動的に更新される場合、`ref`番号が変わる可能性がある
- その場合は再度`find`ツールで検索し直す
- 各項目チェック後、次の項目に進む前に短い待機は不要（連続実行可能）

---

### ステップ7: CSV出力の実行

#### 操作
1. ページ下部の「CSV出力」ボタンをクリック
2. ローディング画面が表示されるので3秒待機
3. 処理完了を確認（画面が元に戻る）

#### 技術的詳細
- **要素**: `button`
- **type**: `"button"`
- **テキスト**: `"CSV出力"`
- **検索**: `find(query="CSV出力", tabId=<TAB_ID>)`

#### コマンド例
```python
# 1. ボタンを検索
find(query="CSV出力", tabId=<TAB_ID>)

# 2. クリック
computer(action="left_click", ref="ref_539", tabId=<TAB_ID>)

# 3. 待機
computer(action="wait", duration=3, tabId=<TAB_ID>)
```

#### 確認方法
- ローディングアニメーション（白い円が回転）が表示される
- 処理完了後、画面が元の状態に戻る
- CSVファイルのダウンロードが自動的に開始される

---

## トラブルシューティング

### 問題1: ドロップダウンが正しく選択されない

**症状**: クリック方式で選択しても値が変わらない

**解決策**: `form_input`ツールを使用して直接値を設定する

---

### 問題2: ref番号が見つからない

**症状**: `form_input`実行時に「No element found with reference」エラー

**解決策**:
- ページが更新されている可能性がある
- `find`ツールで再検索
- 新しい`ref`番号を使用

---

### 問題3: 項目が見つからない（「発送日時」など）

**症状**: `find`ツールで項目が見つからない

**解決策**:
- その項目はシステムに存在しない可能性がある
- 類似の項目名で検索を試みる
- 存在しない場合はスキップして次へ進む

---

### 問題4: ページの読み込みが遅い

**症状**: クリック後に画面が変わらない

**解決策**:
- `wait`アクションで追加の待機時間を設定（2-3秒）
- `screenshot`で現在の状態を確認

---

## 重要なポイント

### ツールの使い分け
- **`form_input`**: ドロップダウン、チェックボックス、テキスト入力に最適
- **`computer + left_click`**: ボタンクリックに使用
- **`find`**: 要素の検索と特定
- **`read_page`**: 要素の構造確認と`ref`番号の特定

### 待機時間の目安
- ページ遷移後: **2秒**
- ドロップダウン変更後: **2秒**
- CSV出力クリック後: **3秒**

### ref番号について
- `ref`番号はページの状態により変動する
- 常に`find`ツールで最新の位置を特定すること
- 同じ手順でもセッションごとに`ref`番号が異なる可能性がある

---

## 手順実行のチェックリスト

- [ ] 帳票管理画面に移動完了
- [ ] 汎用検索画面に移動完了（新しいタブ）
- [ ] データ種別「売上データ(伝票 + 伝票明細)」選択完了
- [ ] 店舗「{{店舗表記}}」選択完了
- [ ] 期間設定完了（開始: {{開始日}}、終了: {{終了日}}）
- [ ] H.店舗 チェック完了
- [ ] H.伝票番号 チェック完了
- [ ] H.伝票処理日 チェック完了
- [ ] H.曜日 チェック完了
- [ ] H.客数（合計）チェック完了
- [ ] D.商品カテゴリ1 チェック完了
- [ ] D.商品カテゴリ2 チェック完了
- [ ] D.価格 チェック完了
- [ ] D.数量 チェック完了
- [ ] D.オーダー日時 チェック完了
- [ ] D.オーダーステータス チェック完了
- [ ] CSV出力ボタンクリック完了
- [ ] ダウンロード開始確認

---

## 所要時間

**推定実行時間**: 約30-45秒（各ステップの待機時間を含む）
