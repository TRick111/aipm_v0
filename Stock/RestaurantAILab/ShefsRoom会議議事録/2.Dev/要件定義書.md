### n8n：Zoomトランスクリプト自動要約・保存 要件定義書（初版）

最終更新: 2025-08-19 / 作成: System

---

### 1. 背景・目的
- Zoom 会議終了後、自動でトランスクリプトを取得し、整形（タイムスタンプ削除・話者連結）したうえで、
  - フローA: 会議メタ情報（日時・クライアント名・参加者）を抽出（Gemini 2.5 Pro）
  - フローB: カスタムプロンプトに基づく議事録要約（Gemini 2.5 Pro）
  を実行し、Google Drive（Google ドキュメント形式）へ保存する。

### 2. スコープ
- 本要件は n8n Cloud 上で動作する 1 本のメインワークフロー（Webhook トリガー）および、その中の 2 系統（A/B）の処理を対象とする。
- 外部 CLI/シェルは使用せず、n8n の Code（JavaScript）ノードで前処理を実装する。
- 認証は「ID/パスワードのシンプル認証」を前提（暫定）。

### 3. トリガー/入力
- トリガー: Zoom Webhook `transcription_completed`
  - 目的: 会議終了後、クラウドトランスクリプト生成完了を契機に実行。
- Webhook ペイロード: Zoom 公式ドキュメント準拠（ダウンロード URL 等の取得方法は未確定 → 設計時に確認）。
- トランスクリプト形式: VTT（想定）。

### 4. 実行環境・設計方針
- 実行環境: n8n Cloud
- 実装方針:
  - 前処理は Code ノード（JavaScript）で実装（既存シェルスクリプトの移植）
  - LLM:
    - フローA: Google Gemini 2.5 Pro（抽出）
    - フローB: Google Gemini 2.5 Pro（要約）
  - 出力: Google Drive 上に Google ドキュメントで保存（Markdown ベースの構造を反映）
- 機密情報: ユーザー方針として「特に使用しない」想定。ただし LLM/Google/Zoom API 利用に必要なキー/認証は n8n Credentials で管理（最低限）。

### 5. 全体フロー（概要）
1) Webhook（Zoom: transcription_completed）を受信
2) ペイロードからトランスクリプト取得先を特定 → HTTP Request で VTT を取得
3) Code(JS) 前処理①: タイムスタンプ/番号/ヘッダ除去（stripVtt 相当）
4) Code(JS) 前処理②: 同一話者の連続発話を結合（mergeSameSpeaker 相当）
5) 分岐（A/B）
   - A: Gemini でメタ情報抽出 → Markdown 生成 → Google Docs 作成
   - B: Gemini 2.5 Pro で要約生成（`1.PoC/prompt.md` 方針準拠）→ Google Docs 作成
6) 任意: 整形済みトランスクリプトのアーカイブ保存（Google Drive）

### 6. 前処理仕様（シェルの JS 実装化）
- 参照元:
  - `1.PoC/stripvtt.sh`（WEBVTT ヘッダ/番号/タイムスタンプ/空行の削除）
  - `1.PoC/merge_same_speaker.sh`（同一話者連続行の結合、半角/全角コロン対応、句読点考慮）

#### 6.1 stripVtt（JavaScript 要件）
- 入力: VTT テキスト
- 処理:
  - CR 文字削除（LF 統一）
  - `^WEBVTT` 行を削除
  - 数字のみの行（会話番号）を削除
  - タイムスタンプ行を削除（`hh:mm:ss.mmm --> hh:mm:ss.mmm`）
  - 先頭/末尾スペース除去、空行削除
- 出力: スピーカ行と本文のみのクリーンテキスト

```javascript
function stripVtt(vttText) {
  const lf = vttText.replace(/\r/g, "");
  const lines = lf.split("\n");
  const ts = /^\d{2}:\d{2}:\d{2}\.\d{3}\s-->\s\d{2}:\d{2}:\d{2}\.\d{3}(?:.*)?$/;
  const out = [];
  for (const raw of lines) {
    const s = raw.trim();
    if (!s) continue;                         // 空行除去
    if (s === 'WEBVTT') continue;             // ヘッダ除去
    if (/^\d+$/.test(s)) continue;            // 番号行除去
    if (ts.test(s)) continue;                 // タイムスタンプ行除去
    out.push(s);
  }
  return out.join("\n");
}
```

#### 6.2 mergeSameSpeaker（JavaScript 要件）
- 入力: `stripVtt` 後のテキスト
- 処理:
  - 行頭から最初に出現するコロン（半角`:`/全角`：`）で「話者」「本文」を分割
  - 直前と同じ話者なら本文を結合
    - 区切りは基本スペース 1 個
    - ただし直前が終端句読点（`。．.!?！？`）または次頭が句読点（`、。．,!?！？`）なら区切りなし
  - 異なる話者/話者形式でない行はフラッシュ
- 出力: `話者: 本文` の連結済み行

```javascript
function mergeSameSpeaker(inputText) {
  const lines = inputText.split('\n');
  const endPunct = /[。．.!?！？]$/;
  const startPunct = /^[、。．,!?！？]/;
  let lastSpeaker = "";
  let buffer = "";
  const out = [];

  const flush = () => {
    if (buffer) {
      out.push(`${lastSpeaker}: ${buffer}`);
      buffer = ""; lastSpeaker = "";
    }
  };

  for (const line of lines) {
    const idxHalf = line.indexOf(":");
    const idxFull = line.indexOf("：");
    let idx = -1;
    if (idxHalf === -1) idx = idxFull; else if (idxFull === -1) idx = idxHalf; else idx = Math.min(idxHalf, idxFull);

    if (idx > -1) {
      const speaker = line.slice(0, idx).trim();
      const text = line.slice(idx + 1).replace(/^\s+/, "");
      if (!lastSpeaker || lastSpeaker === speaker) {
        if (!buffer) { lastSpeaker = speaker; buffer = text; }
        else {
          const sep = (endPunct.test(buffer) || startPunct.test(text)) ? "" : " ";
          buffer = buffer + sep + text;
        }
      } else {
        flush();
        lastSpeaker = speaker; buffer = text;
      }
    } else {
      flush();
      out.push(line);
    }
  }
  flush();
  return out.join('\n');
}
```

### 7. フローA：メタ情報抽出（Google Gemini 2.5 Pro）
- 目的: ミーティング日時、クライアント名、参加者（氏名）を抽出。
- 入力: 前処理後テキスト（必要に応じて先頭数百行に限定可）
- 推論: Gemini Google Gemini 2.5 Pro を使用（抽出指示プロンプト）
- 出力（Markdown; Google ドキュメントに反映）例:

```markdown
# 会議メタ情報
- ミーティング日時: 2025-08-18 14:00-15:00 (JST)
- クライアント名: 〇〇株式会社
- 参加者:
  - 山田 太郎（クライアント）
  - 佐藤 花子（コンサル）
```

- 保存: Google Drive の所定フォルダに Google ドキュメントで作成（ファイル名規約参照）。

### 8. フローB：要約（Gemini 2.5 Pro）
- 目的: `1.PoC/prompt.md` に準拠した構成で要約を作成。
- 入力: 前処理後テキスト（必要に応じチャンク分割）
- 推論: Google Gemini 2.5 Pro（最新エンドポイント; API/ノードは n8n で選択）
- 出力（Markdown; Google ドキュメントへ）は以下の章立てを基本とする:
  - 「クライアントから聞いた内容」
  - 「クライアントに伝えた内容」
  - 「ミーティング内で決定したこと」
  - 「今後のアクションアイテムと担当者（テーブル）」

### 9. ノード構成（n8n 案）
- Webhook（Zoom transcription_completed）
- Function/Code: ペイロード検証・ダウンロード URL 抽出
- HTTP Request: トランスクリプト(VTT)取得
- Code: `stripVtt`
- Code: `mergeSameSpeaker`
- Split In Batches（任意: 長文分割）
- Branch A:
  - Gemini（Google Gemini 2.5 Pro / または HTTP Request）: 抽出
  - Code: Markdown 整形
  - Google Docs: ドキュメント作成
- Branch B:
  - Gemini（2.5 Pro / または HTTP Request）: 要約
  - Google Docs: ドキュメント作成
- Google Drive: （任意）整形済みトランスクリプトのアーカイブ保存（.txt）

### 10. 保存先/命名規約（Google Drive 案）
- フォルダ: `Clients/{クライアント名}/Meetings/{YYYY}/{YYYY-MM-DD}`
- ファイル名:
  - メタ: `{YYYYMMDD}_{Client}_Meta`（Google ドキュメント）
  - 要約: `{YYYYMMDD}_{Client}_Minutes`（Google ドキュメント）
  - 原文整形: `{YYYYMMDD}_{Client}_Transcript_Cleaned.txt`

### 11. データ項目定義（抜粋）
- 会議日時: 文字列（タイムゾーン含む）。抽出不能時は未記入。
- クライアント名: 文字列。抽出不能時は「不明」。
- 参加者: 文字列配列（氏名）。役割/所属は任意。

### 12. エラー/例外（現段階）
- 本案件では「特に定義しない」。最低限の失敗時ログと実行の手動再試行で対処。

### 13. 未確定事項 / リスク
- Zoom からのトランスクリプト取得方法（ペイロードの URL 有無、別 API 参照の要否）は要確認。
- Zoom の認証方式: 「ID/パスワードのシンプル認証」は暫定。実際には OAuth/Server-to-Server OAuth が必要になる可能性が高い。
- Gemini / Gemini の n8n ノード/HTTP 方式はバージョン依存。利用可否を環境で確認。

### 14. 受け入れ基準（最小）
- サンプルトランスクリプト（VTT）で、
  1) タイムスタンプ・番号・ヘッダが削除されていること
  2) 同一話者の連続発話が 1 行に適切に結合されること
  3) フローA: 日時/クライアント名/参加者が Markdown で出力され Google ドキュメントに保存されること
  4) フローB: 指定章立ての要約が Google ドキュメントに保存されること

### 15. 実装メモ（Code ノード組み込み例）

```javascript
// 受信: webhookData
// 1) VTT 取得後
const cleaned = stripVtt(vttText);
const merged = mergeSameSpeaker(cleaned);

// 2) A系: Google Gemini 2.5 Pro へ抽出プロンプトを投げて Markdown 受領
// 3) B系: Gemini へ要約プロンプトを投げて Markdown 受領
// 4) Google Docs ノードへ渡して作成
```

以上


