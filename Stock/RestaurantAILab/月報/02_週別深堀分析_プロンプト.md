# 02: 週別深掘り分析（フェーズ2）（AI手順書）

> 目的/更新履歴は `00_月報作成_統合プロンプト.md` に集約済み。  
> 本ファイルは **AIが参照して実行できる手順** のみを記載します。

---

## 入力（00から渡される前提）
- `{出力ディレクトリ}`
- `{対象月}`
- `{開始日}`
- `{終了日}`
- `{入力売上}`
- `{月報基礎資料}`（フェーズ1で生成済み）

---

## 目的（このフェーズの成果物）
- フェーズ1で作成した `{月報基礎資料}` の **「1.2 週別推移分析」セクションを深掘り更新する**
- 月内で最も好調だった週と最も不調だった週を特定し、詳細比較分析を行う

---

## 参照
- 深掘りスクリプト: `./Scripts/deep_dive_weekly_analysis.py`（月報用・週別深掘り）
- フェーズ1が生成した: `{月報基礎資料}`（週別推移データを含む）
- フェーズ1スクリプト出力: `{出力ディレクトリ}/weekly_in_month.csv`（週別推移データ）
- フェーズ1スクリプト出力: `{出力ディレクトリ}/slide_data_part2.txt`（好調週/不調週の特定済み）
- フェーズ1スクリプト出力: `{出力ディレクトリ}/analysis_results.json`（`best_week` / `worst_week` フィールド）
- 入力データ: `{入力売上}`（rawdata.csv）

---

## 手順（AIが実行）

### 0) 深掘りスクリプトの実行

`deep_dive_weekly_analysis.py` を実行し、数値データを自動生成する。

```bash
python ./Scripts/deep_dive_weekly_analysis.py \
  -m {対象月} \
  --auto \
  --sales-data {入力売上} \
  -o {出力ディレクトリ}
```

> `--auto` を指定すると、フェーズ1で生成された `analysis_results.json` から `best_week` / `worst_week` を自動取得して分析を実行する。

**スクリプト出力**:
| ファイル | 内容 |
|----------|------|
| `slide_data_deep_dive.txt` | 好調週 vs 不調週のサマリー比較表・曜日別・時間帯別・会計レベル・カテゴリ別 |
| `deep_dive_results.json` | 深掘り分析結果（JSON） |

### 1) 深掘り対象週の確認
`analysis_results.json` の `best_week` / `worst_week` フィールド、または `slide_data_part2.txt` の「深掘り対象週」セクションを参照し、好調週/不調週を確認する。

- **好調週**: `best_week`（日平均売上が最大のISO週）
- **不調週**: `worst_week`（日平均売上が最小のISO週）

> ※ スクリプトが日平均売上ベースで自動特定済み。営業日数の違いは吸収されている。  
> ※ AIは `weekly_in_month.csv` の数値を参照し、ISO週の期間（開始日〜終了日）を併記する。

### 2) 5観点で比較分析（好調週 vs 不調週）
以下を必ず比較する（表→解釈→示唆の順）:

1. **曜日別構成**: 各曜日の売上・客数・客単価を好調週/不調週で比較
   - どの曜日が差を生んだか
   - 定休日・臨時休業の有無

2. **時間帯バケット**: 18-20 / 20-22 / 22-24 / 24-26時の客数・売上・会計数
   - ピーク時間帯の違い
   - 深夜帯の売上比率の違い

3. **会計レベル**: 分布（中央値、P10、P90、最大/最小）・高額会計の有無
   - 客単価の分布の違い
   - 高額会計（宴会・グループ）の有無

4. **商品ミックス**: カテゴリTOP、高単価商品の寄与
   - 売れ筋カテゴリの違い
   - 高単価商品の販売数の違い
   - 飲み放題・コースの利用状況

5. **外部要因**: 天候・イベント・祝日の影響
   - 対象週に祝日・連休が含まれるか
   - 天候の影響（雨天日数等）
   - 周辺イベントの有無

### 3) 月報基礎資料へ追記
- `{月報基礎資料}` の **「1.2 週別推移分析」セクション**を更新する
  - 見出し例: `#### 深掘り分析: {好調週} vs {不調週}`
  - 既存の1.2配下に追記/差し替えを行い、**最終的に1.2が"深掘り済みの内容"になっている状態**にする
  - 更新後にファイルを保存する（パスは `{月報基礎資料}` のまま）

---

## 分析の流れ

### Step 1: 対象週の確認
スクリプト出力（`analysis_results.json` の `best_week` / `worst_week`）から以下を確認:
- **好調週**: 日平均売上が最大の週（スクリプトが自動特定済み）
- **不調週**: 日平均売上が最小の週（スクリプトが自動特定済み）
- `weekly_in_month.csv` で各週の実績値を確認する

### Step 2: 深掘り分析の実行
以下の5つの観点で両週を比較分析:

#### 1. 曜日別構成分析
- 月〜日の売上・客数・客単価を好調週/不調週で比較
- どの曜日が売上差の主因か特定
- 定休日・臨時休業による営業日数の違いを確認

#### 2. 時間帯バケット分析
- 時間帯別（営業時間18-26時）の会計数・客数・売上を集計
- ピークタイムの違いと空白時間帯の確認
- 深夜帯（24-26時）の売上比率の比較

#### 3. 会計レベル分析
- 最大会計、最小会計、中央値、P10、P90、平均を算出
- 会計金額分布（~5千円、5千~1万、1万~1.5万、1.5万~2万、2万円以上）
- 高額会計（宴会・グループ）の有無と寄与度

#### 4. 商品ミックス分析
- カテゴリ別売上構成TOP5
- 高単価商品（¥1,500以上）の販売数と総売上
- 飲み放題・コースプランの利用状況
- 人気商品の違い

#### 5. 外部要因分析
- 祝日・連休の有無
- 天候の影響（可能な範囲で）
- 周辺イベント・季節要因

### Step 3: 比較レポート作成
以下のセクションで構成:
1. サマリー比較表（売上、客数、会計数、客単価、日平均売上等）
2. 5つの観点別の詳細分析
3. 総合考察（好調/不調の主要因）
4. 翌月への示唆（改善アクションプラン）

---

## 期待される成果物

### スクリプト出力（自動生成）
- `{出力ディレクトリ}/slide_data_deep_dive.txt` — 比較表データ（スライド第2部用）
- `{出力ディレクトリ}/deep_dive_results.json` — 詳細結果（JSON）

### Markdownレポート（AI作成）
月報基礎資料の「1.2 週別推移分析」セクションに追加:
- `#### 深掘り分析: W02(好調) vs W04(不調)` のような見出し
- サマリー比較表（`slide_data_deep_dive.txt` のデータを使用）
- 5つの観点別詳細分析（スクリプト出力 + AI考察）
- 総合考察と翌月への示唆

---

## 注意事項

1. **営業日基準の日付**: 深夜0-5時は前日の営業日としてカウント
2. **会計レベルの集計**: トランザクションレベルではなく、account_id単位で集計
3. **月初/月末の週の扱い**: ISO週が月をまたぐ場合、営業日ベースで月に帰属させる。日平均で比較することで営業日数の違いを吸収する
4. **ISO 8601週番号**: 年をまたぐ週は翌年の週番号（例: 2025-12-29〜2026-01-03 = 2026-W01）

---

## カスタマイズポイント

### 比較対象の変更
デフォルト: 月内の好調週 vs 不調週
→ 前年同月の同じ週との比較も可能

### 高単価商品の閾値変更
デフォルト: ¥1,500以上
→ 店舗の価格帯に応じて変更可能

### 会計金額分布の区分変更
デフォルト: ~5千円、5千~1万、1万~1.5万、1.5万~2万、2万円以上
→ 店舗の客単価に応じて変更可能

---

## チェックリスト（フェーズ2完了条件）
- 好調週/不調週が特定できている（ISO週番号と期間付き）
- 5観点の比較が揃っている
- `{月報基礎資料}` に深掘りセクションが追記されている
- 日平均売上で比較し、営業日数の違いが考慮されている
