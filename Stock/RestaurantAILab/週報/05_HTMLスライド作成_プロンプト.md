# 05: HTMLスライド作成（フェーズ5）— D3.js + HTML週報スライド（AI手順書）

> 目的/更新履歴は `00_週報作成_統合プロンプト.md` に集約済み。  
> 本ファイルは **AIが参照して実行できる手順** のみを記載します。

---

## 入力（前フェーズから渡される前提）

- `{運営会社コード}`（例: `BFA`）
- `{対象週}`（例: `2026-W06`）
- `{終了日}`（例: `2026-02-08`）
- `{week_slug}`（例: `2026w06`）
- `{出力ディレクトリ}`（例: `./2_output/BFA/2_output_2026w06`）
- `{スライド構成}`（フェーズ3+4で完成済みの `週報スライド構成案.md`）

---

## 参照

- **必須入力**: `{スライド構成}`（Markdownのスライド構成案。全スライドのタイトル・データ表・メッセージが含まれる）
- **グラフライブラリ**: D3.js v7（CDN: `https://d3js.org/d3.v7.min.js`）

---

## 手順（AIが実行）

### 1) スライド構成案の読み込みと確認

- `{スライド構成}` を全文読み込む
- スライド総数を確認し、控える（例: 32枚 = 28枚 + 日報3〜5枚）
- **スライド枚数は構成案に厳密に従う**（追加・省略は一切不可）
- ファイル名: `{終了日の開始日}_{終了日}_{店名}_週次報告資料.html`
  - 開始日は `{終了日}` から6日前（月曜始まり）
  - 例: `20260202_20260208_BAR_FIVE_Arrows_週次報告資料.html`

### 2) HTML構造の設計

#### 2.1 基本構造

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{店舗名} 週次営業報告 — {対象週}</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* 全スタイルをここに記述（外部CSS不使用） */
  </style>
</head>
<body>
  <!-- スライド1 -->
  <div class="slide" id="slide-1">
    ...
  </div>

  <!-- スライド2 -->
  <div class="slide" id="slide-2">
    ...
  </div>

  <!-- 以下、全スライド分 -->

  <script>
    // D3.jsグラフ描画スクリプトをここに記述
  </script>
</body>
</html>
```

**重要**: 単一HTMLファイルで完結させる（外部CSS/JSファイルは使用しない。D3.js CDNのみ外部参照）

#### 2.2 スライドヘッダーの形式

各スライドのヘッダーは以下の形式で統一すること:

```html
<div class="slide-header"><h2>スライドタイトル</h2><span class="pn">N / 総枚数</span></div>
```

- `<h2>` タグでタイトルを囲む（font-size: 32px, font-weight: 700）
- ページ番号 `<span class="pn">` を右端に配置（font-size: 16px, opacity: 0.7）
- セクションタグが必要な場合は `<h2>` 内に含める: `<h2><span class="section-tag">第1部</span> タイトル</h2>`

```css
.slide-header {
  background: #1E3A5F;
  color: #fff;
  padding: 14px 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.slide-header h2 { font-size: 32px; font-weight: 700; }
.slide-header .pn { font-size: 16px; opacity: 0.7; }
.slide-header .section-tag {
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
}
```

#### 2.3 PDF改ページの実装

各スライドが印刷/PDF出力時に1ページとして分離されるよう、以下のCSSを必ず適用する:

```css
@media print {
  body {
    margin: 0;
    padding: 0;
  }
  .slide {
    page-break-after: always;
    page-break-inside: avoid;
    break-after: page;
    break-inside: avoid;
  }
  .slide:last-child {
    page-break-after: auto;
  }
}

/* 画面表示用 */
@media screen {
  .slide {
    margin: 0 auto 40px auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
  }
}
```

#### 2.4 スライドサイズ

- **16:9** アスペクト比
- 固定サイズ: `width: 1280px; height: 720px;`
- `overflow: hidden;` でスライドからのはみ出しを防止

```css
.slide {
  width: 1280px;
  height: 720px;
  position: relative;
  overflow: hidden;
  background: #ffffff;
  font-family: 'Helvetica Neue', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
}
```

---

### 3) デザイン方針

#### 3.1 カラーパレット

| 用途 | 色名 | HEXコード | 使い方 |
|:---|:---|:---|:---|
| **ヘッダー背景** | ダークネイビー | `#1E3A5F` | スライドヘッダーの帯、タイトル背景 |
| **ポジティブ（増加・好調）** | グリーン | `#22C55E` | 前週比プラス、好調曜日ハイライト |
| **ネガティブ（減少・不調）** | レッド | `#EF4444` | 前週比マイナス、不調曜日ハイライト |
| **注目・変化** | オレンジ | `#F97316` | 吹き出し、矢印、アノテーション背景 |
| **当週データ** | メインブルー | `#3B82F6` | 棒グラフ・折れ線グラフの当週系列 |
| **4週平均/比較データ** | グレー | `#94A3B8` | 比較用の棒グラフ・折れ線 |
| **スライド背景** | ライトグレー | `#F8FAFC` | スライド全体の背景 |
| **テキスト（本文）** | ダークグレー | `#334155` | 本文テキスト |
| **テキスト（見出し）** | ネイビー | `#1E293B` | 見出し、太字テキスト |

#### 3.2 タイポグラフィ（フォントサイズ階層）— 最重要

**基準: body の font-size は `20px` とする。** 全テキスト要素はこの基準から適切にスケールすること。

**⚠️ 絶対に守ること: 以下のフォントサイズを下回るテキストを使用してはならない。**
- 本文・箇条書き: **最低 `17px`**（`12px` や `13px` は絶対に使用禁止）
- 表セル: **最低 `16px`**
- 施策表: **最低 `15px`**
- インラインの補足テキスト: **最低 `16px`**

| 要素 | フォントサイズ | ウェイト | 用途 |
|:---|:---|:---|:---|
| スライドタイトル（ヘッダー帯） | `32px` | `700` | 各スライドのヘッダー帯に表示 |
| **主張バー（msg-bar）** | `24px` 〜 `27px` | `700` | **各スライドの核心メッセージ（1文）。ヘッダー直下に配置** |
| KPI大数字 | `44px` 〜 `48px` | `800` | 売上金額、主要指標の数値 |
| KPI比較数字 | `22px` 〜 `24px` | `700` | 前週比・前年比のパーセンテージ |
| KPIラベル | `17px` | `600` | KPIカードの指標名 |
| KPIサブテキスト | `18px` | `400` | KPIカードの補足情報 |
| セクション見出し | `22px` 〜 `26px` | `800` | セクション小見出し |
| 本文テキスト | `18px` 〜 `20px` | `400` | 説明文、コメント、箇条書き |
| 表セル | `18px` 〜 `20px` | `400` | テーブルのデータ（`.dt` / `.data-table` クラス） |
| 表ヘッダー | `17px` 〜 `19px` | `700` | テーブルのヘッダー行 |
| 施策一覧表 | `15px` 〜 `16px` | `400` | 施策表のデータ（`.action-table` クラス） |
| 施策一覧ヘッダー | `15px` | `700` | 施策表のヘッダー行 |
| 注釈・キャプション | `14px` | `400` | グラフ軸ラベル、出典（唯一14pxを許容する箇所） |
| **アノテーション（吹き出し）** | `18px` 〜 `22px` | `700` 〜 `800` | グラフ上の吹き出し内テキスト。背景ボックス付きで目立たせる |
| メトリックカードのラベル | `17px` | `600` | メトリックカードの指標名 |
| メトリックカードの値 | `40px` | `800` | メトリックカードの数値 |
| ゲージカードの値 | `48px` | `900` | 前年比等の大きな数値表示 |

**強調ルール**:
- **最も伝えたい数字**はフォントサイズを周囲の **2倍以上** にし、太字 + 色で強調する
- プラスの変化は `#22C55E`（グリーン）、マイナスは `#EF4444`（レッド）
- 比較数字の前に `▲`（増加）/ `▼`（減少）を付ける

#### 3.3 主張バー（msg-bar）— 全スライド共通UI（最重要・絶対必須）

**タイトルスライド以外のすべてのスライドに、ヘッダー帯の直下に「主張バー」を配置すること。これは省略不可。**

主張バーとは、そのスライドで最も伝えたい核心メッセージを**1文で太字表示**するUI部品である。
スライド構成案の各スライドにある **「メッセージ」** 欄の内容を、主張バーのテキストとして使用する。

**主張バーの役割**: 忙しいオーナーが「このスライドで何が言いたいのか」を一目で理解できるようにする。各スライドには必ず1つの主張がある。その主張をオレンジ背景の目立つエリアに大きく表示することで、スライドの読み取りコストを最小化する。

```css
.msg-bar {
  background: #FFF7ED;        /* 薄いオレンジ背景 */
  border-left: 5px solid #F97316;  /* オレンジ左ボーダー */
  padding: 12px 40px;
  font-size: 24px;            /* 主張テキストは大きく（24px以上） */
  font-weight: 700;
  color: #1E293B;
  line-height: 1.4;
}
```

```html
<!-- 使用例: ヘッダー帯 → 主張バー → スライドボディ の順 -->
<div class="slide-header"><h2>曜日別概況</h2><span class="pn">7 / 28</span></div>
<div class="msg-bar">7日中6日が4週平均を下回り、金曜日のみプラス。水曜日の客数要因が最大の不振原因</div>
<div class="slide-body">
  <!-- コンテンツ -->
</div>
```

**注意（必ず守ること）**:
- 主張バーはスライドヘッダーの**直下**に配置する（`slide-body` の中ではなく外）
- メッセージが長すぎてスライドに収まらない場合は、核心部分を短縮して**1〜2行以内**に収めること
- スライド構成案に「メッセージ」欄がないスライドでも、そのスライドの最も重要なポイントを1文で要約して主張バーに入れること
- タイトルスライド（スライド1）のみ主張バー不要
- **主張バーとは別に、スライド下部に `message-box` 等の要素を追加しない**（主張バーが唯一のメッセージ表示エリア）
- 主張バーのフォントサイズは **`24px` 以上** を維持する（小さくしない）

#### 3.4 レイアウトパターン

スライドの内容に応じて以下のパターンを使い分ける:

| パターン | 構成 | 使用するスライド |
|:---|:---|:---|
| **タイトルスライド** | 中央揃え大見出し + サブタイトル | スライド1 |
| **KPIカード** | 3〜5個のカードを横並び | スライド2, 6 |
| **グラフ + コメント** | 左2/3にグラフ、右1/3にコメント | スライド3-5, 7, 10, 15, 19 |
| **比較表** | ヘッダー付きテーブル | スライド8-17, 21-22 |
| **箇条書き** | 3〜5点の要点 + アイコン | スライド12, 17, 18, 20, 23-25 |
| **施策一覧** | 2カラム表 | スライド26-28 |
| **日報引用** | 引用ブロック並べ | 日報スライド |

---

### 4) D3.jsグラフの描画ルール

#### 4.1 グラフ種別の使い分け

| スライド | グラフ種別 | 説明 |
|:---|:---|:---|
| 売上トレンド | **折れ線グラフ** | 直近5週間の売上推移。当週のドットを大きく強調 |
| 客数トレンド | **折れ線グラフ** | 同上、客数版 |
| 客単価トレンド | **折れ線グラフ** | 同上、客単価版 |
| 曜日別概況 | **棒グラフ（グループ）** | 当週 vs 4週平均の曜日別比較。好調/不調曜日に色分け |
| 深掘り: 時間帯別売上 | **棒グラフ（水平）** | 時間帯別の売上・来客数。主要時間帯を強調 |
| 深掘り: グループサイズ | **棒グラフ（水平）** | グループ規模別の売上・人数。最大グループを強調 |
| 深掘り: 基本数字比較 | **割合棒グラフ（水平）** | 売上・客数・客単価を4週平均比の割合で表示（100%基準線付き） |
| カテゴリ別売上構成比 | **ドーナツチャート** | カテゴリ別の構成比（上位5 + その他）。最大セグメントを外に突出 |

#### 4.2 D3.jsアノテーション・強調のルール（最重要）

グラフの「どこを見るべきか」を明確にするために、以下の装飾を **必ず** 適用する:

##### a) 当週・対象データのハイライト
- 折れ線グラフの当週ドットは **半径を他の2倍（r=8）** にし、`#3B82F6` で塗る
- 棒グラフの好調曜日は `#22C55E`、不調曜日は `#EF4444` で塗る
- それ以外の棒は `#3B82F6`（当週）と `#94A3B8`（4週平均）

##### b) 吹き出し（コールアウト）アノテーション
最も注目すべきデータポイントに、D3.jsで吹き出しを追加する:

```javascript
// 吹き出しの実装パターン
function addCallout(svg, x, y, text, options = {}) {
  const {
    bgColor = '#FFF7ED',      // 薄いオレンジ背景
    borderColor = '#F97316',   // オレンジ枠
    textColor = '#1E293B',     // ダークテキスト
    fontSize = '18px',         // 吹き出しテキストは大きめ
    fontWeight = '800',
    arrowTarget = null         // 矢印の先端座標 {x, y}
  } = options;

  const g = svg.append('g').attr('class', 'callout');

  // 矢印線（データポイントへの引き出し線）
  if (arrowTarget) {
    g.append('line')
      .attr('x1', x).attr('y1', y)
      .attr('x2', arrowTarget.x).attr('y2', arrowTarget.y)
      .attr('stroke', borderColor)
      .attr('stroke-width', 2)
      .attr('stroke-dasharray', '4,3');
  }

  // 背景ボックス
  const padding = { x: 12, y: 8 };
  const textEl = g.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', fontSize)
    .attr('font-weight', fontWeight)
    .attr('fill', textColor)
    .text(text);
  const bbox = textEl.node().getBBox();

  g.insert('rect', 'text')
    .attr('x', bbox.x - padding.x)
    .attr('y', bbox.y - padding.y)
    .attr('width', bbox.width + padding.x * 2)
    .attr('height', bbox.height + padding.y * 2)
    .attr('rx', 6)
    .attr('fill', bgColor)
    .attr('stroke', borderColor)
    .attr('stroke-width', 1.5);
}
```

##### b-2) 右端データポイントの吹き出し位置補正（最重要）

**吹き出しがグラフ右端で見切れる問題を防止するため、以下のルールを必ず適用すること。**

折れ線グラフや棒グラフで、右端（最後）のデータポイントにアノテーションを付ける場合、吹き出しがSVG領域の外にはみ出して見切れることが多い。これを防ぐために:

1. **データポイントのX座標がグラフ描画領域の85%以上の位置にある場合**、吹き出しのX座標を左に30〜50pxずらし、`text-anchor` を `'end'` にする
2. **ずらした場合は、データポイントとの間に破線の引き出し線を描画する**（吹き出しとデータポイントの関係が明確になるように）
3. **棒グラフの日曜日（右端の曜日）のアノテーションも同様に、左にオフセットして配置する**

```javascript
// 右端データポイントの吹き出し位置補正パターン
const dataX = x(lastDataPoint.label);
const chartWidth = innerWidth; // グラフ描画領域の幅

if (dataX > chartWidth * 0.85) {
  // 右端に近い → 吹き出しを左にずらす
  const calloutX = dataX - 40;
  const textAnchor = 'end';
  // 吹き出し描画...
  // + データポイントへの引き出し線を追加
  g.append('line')
    .attr('x1', calloutX + 10).attr('y1', calloutBboxBottom)
    .attr('x2', dataX).attr('y2', dataY - 4)
    .attr('stroke', '#F97316').attr('stroke-width', 1.5)
    .attr('stroke-dasharray', '4,3');
} else {
  // 通常位置（中央揃え）
  const calloutX = dataX;
  const textAnchor = 'middle';
  // 吹き出し描画...
}
```

**この補正は以下の全てのグラフに適用すること:**
- 折れ線グラフの最終データポイント（当週）
- 棒グラフの右端の曜日（日曜日）
- 時間帯別グラフの最終時間帯（24-26時）
- その他、右端に位置するアノテーション全般

##### b-3) グラフ強調手法のバリエーション（最重要・必須）

**吹き出し（コールアウト）以外にも、以下の強調手法を積極的に使い分けること。** 1つのグラフに複数の強調手法を組み合わせることで、どこを見るべきかを明確にする。

**① トレンド矢印（折れ線グラフ）**

直前のデータポイントから当週のデータポイントへ、トレンドの方向を示す矢印を描画する:

```javascript
// SVGマーカー定義 + トレンド矢印
const markerId = svgId + '-trend-arrow';
svg.append('defs').append('marker').attr('id', markerId)
  .attr('viewBox', '0 0 10 10').attr('refX', 8).attr('refY', 5)
  .attr('markerWidth', 8).attr('markerHeight', 8).attr('orient', 'auto-start-reverse')
  .append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z').attr('fill', trendColor);

const ag = g.append('g').attr('opacity', 0.65);
ag.append('line')
  .attr('x1', prevX + 14).attr('y1', prevY + offset)
  .attr('x2', currX - 14).attr('y2', currY - offset)
  .attr('stroke', trendColor).attr('stroke-width', 3.5)
  .attr('marker-end', 'url(#' + markerId + ')');
// 変化率ラベルを矢印の横に表示
ag.append('text')
  .attr('x', midX + 20).attr('y', midY - 8)
  .attr('font-size', '15px').attr('font-weight', '700').attr('fill', trendColor)
  .text(pctChangeLabel); // 例: "-22.9%"
```

使い分け:
- **下降トレンド**: `COLORS.negative`（赤）の矢印 + 変化率ラベル
- **上昇トレンド**: `COLORS.positive`（緑）の矢印 + 変化率ラベル
- 折れ線グラフの**最後の2つのデータポイント間**に自動配置する

**② 丸囲み（楕円エンファシス）**

特定のデータポイントやバー群を囲む破線の楕円を描画する:

```javascript
function addCircleEmphasis(g, cx, cy, rx, ry, color) {
  g.append('ellipse')
    .attr('cx', cx).attr('cy', cy).attr('rx', rx).attr('ry', ry)
    .attr('fill', 'none').attr('stroke', color).attr('stroke-width', 2.5)
    .attr('stroke-dasharray', '6,3');
}
```

使い分け:
- 曜日別棒グラフで**最も好調な曜日のバー群**を囲む（緑の楕円）
- ドーナツチャートで**最大セグメント**の周囲に配置
- 棒グラフで**最大値のバー**を目立たせる

**③ 背景ハイライトバンド**

特定の行・バーの背後に薄い色の帯を敷いて、注目エリアを示す:

```javascript
function addHighlightBand(g, x, y, width, height, color) {
  g.insert('rect', ':first-child')
    .attr('x', x).attr('y', y)
    .attr('width', width).attr('height', height)
    .attr('fill', color).attr('rx', 6).attr('opacity', 0.4);
}
```

使い分け:
- 時間帯別棒グラフの**最大売上時間帯**の背景にピンク/グリーンの帯
- 割合棒グラフの**最低値の行**にピンクの帯（`#FEF2F2`）
- 曜日別グラフの**不調曜日**の背景にピンクの帯

**④ 太枠（ボールドアウトライン）**

特定のバーに太い枠線を追加して視覚的に目立たせる:

```javascript
function addBarOutline(g, x, y, width, height, color) {
  g.append('rect')
    .attr('x', x - 1.5).attr('y', y - 1.5)
    .attr('width', width + 3).attr('height', height + 3)
    .attr('fill', 'none').attr('stroke', color).attr('stroke-width', 3).attr('rx', 5);
}
```

使い分け:
- グループサイズ別バーの**MAX売上グループ**
- 時間帯別バーの**最大売上時間帯**
- 商品別バーの**トップカテゴリ**
- 割合棒グラフの**最低/最高の指標**

**⑤ バッジラベル（タグ）**

「MAX」「要改善」「★ 好調」などの短いラベルを背景ボックス付きで配置:

```javascript
function addBadge(g, cx, cy, text, color, bgColor) {
  const bg = g.append('g');
  const bt = bg.append('text').attr('x', cx).attr('y', cy)
    .attr('text-anchor', 'middle').attr('font-size', '16px').attr('font-weight', '800')
    .attr('fill', color).text(text);
  const bb = bt.node().getBBox();
  bg.insert('rect', 'text')
    .attr('x', bb.x - 6).attr('y', bb.y - 3)
    .attr('width', bb.width + 12).attr('height', bb.height + 6)
    .attr('rx', 4).attr('fill', bgColor).attr('stroke', color).attr('stroke-width', 1.5);
}
```

使い分け:
- グループサイズ別: 最大グループに **`MAX`** バッジ
- 割合棒グラフ: 50%以下の指標に **`▼ 要改善`** バッジ
- 割合棒グラフ: 130%以上の指標に **`★ 好調`** バッジ
- 時間帯別: 最大時間帯に **`売上の○○%`** バッジ

**⑥ ドーナツチャートの突出（Explode）**

最大セグメントを中心から10px程度外側に引き出す:

```javascript
arcs.filter((d, i) => i === 0).attr('transform', d => {
  const [cx, cy] = arc.centroid(d);
  const dist = Math.sqrt(cx * cx + cy * cy);
  return `translate(${cx / dist * 10}, ${cy / dist * 10})`;
});
```

**⑦ 割合棒グラフ（複数指標の比較用）**

売上・客数・客単価など複数の指標を1つのグラフで比較する場合、**絶対値ではなく4週平均（または前年）に対する割合（%）で棒を描画**する:

```javascript
// 4週平均 = 100% を基準線とし、各指標の割合を棒で表示
// 100%ラインを太い実線で描画
// 棒の右側に実数値を表示
// 80%未満は赤、120%以上は緑、その間は青
function drawRatioBar(svgId, labels, thisW, avg4, fmtFns, color) {
  // ... 割合を計算して横棒グラフで描画
  // 100% = 4週平均の基準線
  // 棒の長さ = thisW[i] / avg4[i] * 100 (%)
  // 棒の右外側にフォーマット済みの実数値を表示
}
```

**注意**: 複数指標を比較するスライド（好調/不調曜日の基本数字など）では、**必ず**この割合棒グラフを使用すること。絶対値の棒グラフでは売上（万円単位）と客数（十人単位）のスケールが違い、比較が困難になるため。

**強調手法の適用ルール（まとめ）:**

| グラフ種別 | 必須の強調手法 |
|:---|:---|
| 折れ線グラフ | ①トレンド矢印 + 吹き出し（最終データポイント） |
| 曜日別棒グラフ | 吹き出し（最高/最低） + ②丸囲み（最高） + ③背景帯（最低） |
| 割合棒グラフ | ④太枠 + ③背景帯 + ⑤バッジ |
| 時間帯別棒グラフ | ③背景帯 + ④太枠 + ⑤バッジ（最大時間帯） |
| グループサイズ棒グラフ | ④太枠 + ⑤バッジ（MAX） |
| 商品別棒グラフ | ④太枠（トップ） + 非最大バーの透明度を下げる |
| ドーナツチャート | ⑥突出（最大セグメント） |

##### c) 増減矢印の表示
前週比・前年比・4週平均比の数値の横に、SVGの矢印アイコンを付ける:

```javascript
// ▲ 増加（グリーン）
function upArrow(svg, x, y) {
  svg.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', '18px')
    .attr('fill', '#22C55E')
    .attr('font-weight', '800')
    .text('▲');
}

// ▼ 減少（レッド）
function downArrow(svg, x, y) {
  svg.append('text')
    .attr('x', x).attr('y', y)
    .attr('font-size', '18px')
    .attr('fill', '#EF4444')
    .attr('font-weight', '800')
    .text('▼');
}
```

##### d) 基準線・4週平均ライン
4週平均値を破線で水平に引く:

```javascript
// 4週平均 基準線
svg.append('line')
  .attr('x1', marginLeft).attr('x2', width - marginRight)
  .attr('y1', yScale(avg4w)).attr('y2', yScale(avg4w))
  .attr('stroke', '#F97316')
  .attr('stroke-width', 1.5)
  .attr('stroke-dasharray', '6,4');

svg.append('text')
  .attr('x', width - marginRight + 4)
  .attr('y', yScale(avg4w) + 4)
  .attr('font-size', '12px')
  .attr('fill', '#F97316')
  .attr('font-weight', '600')
  .text('4週平均');
```

##### e) フォントサイズによる強調
グラフ上の数値ラベルで、最大値・最小値・注目値のフォントサイズを大きくする:

```javascript
// 通常のデータラベル（最低16px）
bars.append('text')
  .text(d => `¥${d.value.toLocaleString()}`)
  .attr('font-size', d => d.isHighlight ? '20px' : '16px')
  .attr('font-weight', d => d.isHighlight ? '800' : '500')
  .attr('fill', d => d.isHighlight ? '#1E293B' : '#64748B');
```

**⚠️ グラフ内のフォントサイズ最低基準:**
- 軸ラベル（X軸・Y軸）: **最低 `14px`**
- データラベル（バーの横の数値）: **最低 `16px`**、強調時は `18px` 〜 `24px`
- チャートタイトル: **最低 `20px`**
- 凡例テキスト: **最低 `16px`**
- アノテーション/バッジ: **最低 `16px`**
- **`10px`〜`12px` のフォントサイズはグラフ内でも使用禁止**

#### 4.3 グラフ共通設定

```javascript
// 全グラフ共通のマージン
const margin = { top: 40, right: 40, bottom: 40, left: 60 };

// 軸ラベルのフォント
const axisStyle = {
  fontSize: '12px',
  fontFamily: "'Helvetica Neue', 'Hiragino Kaku Gothic ProN', sans-serif",
  color: '#64748B'
};

// グリッド線（Y軸）
svg.append('g')
  .attr('class', 'grid')
  .selectAll('line')
  .data(yScale.ticks(5))
  .join('line')
  .attr('x1', margin.left)
  .attr('x2', width - margin.right)
  .attr('y1', d => yScale(d))
  .attr('y2', d => yScale(d))
  .attr('stroke', '#E2E8F0')
  .attr('stroke-dasharray', '3,3');
```

---

### 5) スライド種別ごとの実装ガイド

#### 5.1 タイトルスライド（スライド1）

```css
.slide-title {
  background: linear-gradient(135deg, #1E3A5F 0%, #0F172A 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #fff;
}
.main-title { font-size: 48px; font-weight: 800; }
.sub-title { font-size: 28px; font-weight: 400; margin-top: 12px; opacity: 0.9; }
.period { font-size: 18px; margin-top: 24px; opacity: 0.7; }
```

#### 5.2 KPIカードスライド（スライド2, 6）

- KPIを3〜5個のカードとして横並びに配置
- 各カードに: **指標名**（小さく） → **実績値**（大きく太字） → **前週比/前年比**（色付き）
- 前週比がプラスなら `#22C55E` + `▲`、マイナスなら `#EF4444` + `▼`

```html
<div class="kpi-card">
  <span class="kpi-label">週間売上</span>
  <span class="kpi-value">¥850,000</span>
  <span class="kpi-change positive">▲ 前週比 +8.5%</span>
  <span class="kpi-change-sub">4週平均比 +12.3%</span>
</div>
```

#### 5.3 折れ線グラフスライド（スライド3-5）

- D3.jsで折れ線グラフを描画
- 当週のデータポイントにドットを大きく表示（`r=8`）
- 当週ドットの上に **吹き出しアノテーション** でKPI値を表示
- **直前の週→当週の間にトレンド矢印を描画**（上昇=緑、下降=赤、変化率%のラベル付き）
- 前年同週のデータポイントがあれば、薄い破線で別系列として表示
- 右1/3のコメント欄に「トレンド読み取り」を記載
- 軸ラベルは **`16px`以上**、4週平均ラベルは **`14px`以上**

#### 5.4 棒グラフスライド（曜日別概況、深掘り）

- 好調曜日は `#22C55E`、不調曜日は `#EF4444`、その他は `#3B82F6`
- 4週平均の棒は `#94A3B8`（グレー）で当週の隣にグループ表示
- 4週平均の基準線を破線で表示
- 好調/不調の棒にのみ **吹き出しアノテーション** を配置
- 好調/不調の棒のデータラベルは **フォントサイズ18px以上・太字**、その他は **16px・通常**
- 棒グラフの軸ラベルは **最低14px**、データラベルは **最低16px**

##### 複数指標比較時の割合棒グラフ（重要）

好調/不調曜日の「基本数字」スライドのように、売上・客数・客単価などの**異なるスケールの指標を1つのグラフで比較する場合**は、**絶対値ではなく、4週平均に対する割合（%）で横棒グラフを描画**すること。

- 100%ライン = 4週平均の基準線（太い実線で表示）
- 各指標の棒の長さ = 今週実績 ÷ 4週平均 × 100（%）
- 棒の右側に **フォーマット済みの実数値** を表示（例: ¥42,810、11人）
- 棒の色: 80%未満=赤、120%以上=緑、その間=青
- 最低値の行に背景ハイライトバンド + 太枠 + バッジ（「▼ 要改善」）

**理由**: 絶対値の棒グラフでは、売上（数万円〜数十万円）と客数（十数人）のスケールが大きく異なるため、同一スケールで意味のある比較ができない。割合にすることで「どの指標が最も悪いか」が一目で分かる。

#### 5.5 ドーナツチャート（カテゴリ別構成比）

- D3.jsの `d3.arc()` で描画
- 上位3カテゴリは個別色、残りは `#E2E8F0`（ライトグレー）でまとめる
- **最大カテゴリのセグメントを中心から10px外側に引き出す**（explode効果）
- 中央に「合計金額」を大きく表示（`24px` 以上）
- セグメント上のラベル（構成比%）は **`14px` 以上**
- 中央テキストのラベルは `18px`、金額は `24px` 以上

#### 5.6 表スライド（商品TOP10、深掘り比較表）

- HTML `<table>` でスタイリング
- ヘッダー行は `#1E3A5F` 背景 + 白文字
- 交互行に薄い背景色（`#F8FAFC`）
- 最大値のセルは **太字 + 色変更** で強調
- 増減列はプラス/マイナスで色分け

##### 表の行ハイライト（重要）

msg-barで主張している内容に関連するデータ行は、視覚的に強調すること。例えば「コース&セットが最大カテゴリ」という主張がある場合、そのカテゴリの行を強調する:

```html
<!-- 通常の行 -->
<tr><td>ウイスキー</td><td>¥41,100</td><td>6.8%</td></tr>

<!-- 強調行（主張と関連するデータ） -->
<tr style="background:#FFF7ED;border-left:4px solid #F97316;">
  <td style="font-weight:800;color:#C2410C;">🏆 コース&セット</td>
  <td style="text-align:right;font-weight:800;color:#C2410C;">¥140,000</td>
  <td style="text-align:right;font-weight:800;color:#F97316;font-size:20px;">23.0%</td>
</tr>
```

強調手法のバリエーション:
- **背景色変更**: `background:#FFF7ED`（薄いオレンジ）で行全体をハイライト
- **左ボーダー**: `border-left:4px solid #F97316` で行の左端にオレンジの帯
- **太字＋色変更**: `font-weight:800; color:#C2410C` でテキストを目立たせる
- **絵文字**: 🏆（最大）、⚠️（要注意）、📈（増加）、📉（減少）を行頭に添える

**ルール**: msg-barの主張に直接関連する行は必ず1行以上ハイライトすること。

#### 5.7 日報引用スライド

- 引用ブロック（`blockquote`）を並べる
- 左端に `3px solid #3B82F6` のボーダー
- 日付・氏名は太字、引用テキストは通常ウェイト
- グラフは不要（テキストのみ）

#### 5.8 施策一覧スライド

- 2カラムの表形式
- 施策名は太字、「狙い」列は通常ウェイト
- 行ごとに薄い背景色の交互表示

#### 5.9 絵文字・ピクトグラムの活用（重要）

**カード・箇条書き・まとめスライドでは、絵文字（Emoji）を活用して視覚的にイメージを伝えやすくすること。**

忙しいオーナーがスライドを一目で理解するために、テキストだけでなく絵文字のアイコンを添えることで、内容の種類や感情をすばやく把握できるようにする。

##### 適用箇所

| 箇所 | 効果 | 例 |
|:---|:---|:---|
| **success-item / challenge-item カード** | 強み/課題の種類を即座に伝える | 🎯 好調、⚠️ 要注意、📈 成長、💰 課題 |
| **bullet-list の .icon 要素** | 番号の代わりに内容を示す絵文字 | 🚨 警告、📉 下降、👥 人数、🎉 成功 |
| **カード型まとめの行頭** | 施策・方向性のカテゴリ表示 | 📋 予約、⏰ 時間帯、🍽️ メニュー、🏢 法人 |
| **テーブルの強調行** | 最大値・最小値のマーキング | 🏆 1位、⚠️ 要改善 |
| **比較カードのラベル** | プラス/マイナスの直感的表現 | 🟢 プラス、🔴 マイナス |

##### 絵文字の選び方

- **成功・好調**: 🎯 🎉 📈 🌱 ★ 🏆
- **課題・不調**: ⚠️ 📉 💰 🚨 🔴
- **カテゴリ表現**: 🍸（カクテル）🍽️（フード）📋（管理）⏰（時間）🏢（法人）📅（スケジュール）🥂（イベント）🎨（ブランド）🥤（ドリンク）
- **比較・分析**: 📊（データ）📈（上昇）📉（下降）🟢（プラス）🔴（マイナス）

##### 実装パターン

```html
<!-- success-item カードに絵文字 -->
<div class="success-item">
  <h4 style="color:#22C55E;">🎯 金曜日が4週平均比+65.4%の大幅好調</h4>
  <p>売上¥231,520、客数35人...</p>
</div>

<!-- bullet-list に絵文字アイコン -->
<li>
  <div class="icon" style="font-size:28px">🚨</div>
  <div class="text"><strong>会計数の圧倒的不足</strong>...</div>
</li>

<!-- カード型まとめに絵文字 -->
<div style="background:#F8FAFC; border-radius:8px; padding:12px 16px; font-size:17px;">
  📋 水曜日のグループ予約獲得（平日限定コースプラン）
</div>
```

**ルール**: テキストだけのカードや箇条書きは避け、内容に合った絵文字を行頭に必ず1つ添える。

---

### 6) データの正確性（最重要）

#### 表データの完全一致
- スライドに表を含める場合、表内の文字・数値は `{スライド構成}` の記載と **1文字も違わず一致** させること
- 構成案の表をスライドに転記する際は、必ずセル単位で照合すること

#### 固有名詞の正確性
- 商品名・カテゴリ名・店舗名などの固有名詞は、表記揺れ・誤字・脱字が **絶対にない** よう、構成案の記載を正確に転記すること
- 以下のようなミスは不可:
  - 英字の大文字/小文字の違い（例: `Hojicha Negroni` → `Hojicha negroni` は NG）
  - 漢字/ひらがなの表記揺れ（例: `山葵と梨のスマッシュ` → `わさびと梨のスマッシュ` は NG）
  - 中点・スペースの有無（例: `ジャパニーズカクテル` → `ジャパニーズ・カクテル` は NG）
  - カテゴリ名の省略（例: `ウイスキー（ハイボール・ボトル・オリジナル）` → `ウイスキー（HB・ボトル）` は NG）

#### 数値の正確性
- 金額・パーセンテージ・人数などは構成案の値をそのまま使用する
- 丸め・再計算・独自の集計は行わない

#### D3.jsグラフのデータ
- グラフに使用するデータは、構成案の「グラフ用データ」表から正確に転記する
- JavaScript内でデータを `const data = [...]` として直接記述する（外部JSONファイルは使用しない）

---

### 7) 出力形式

#### 出力ファイル
- `{出力ディレクトリ}/{開始日}_{終了日}_{店名}_週次報告資料.html`
  - 例: `./2_output/BFA/2_output_2026w06/20260202_20260208_BAR_FIVE_Arrows_週次報告資料.html`

#### PDF出力方法（ユーザーが実行）
1. HTMLファイルをブラウザ（Chrome推奨）で開く
2. `Ctrl+P`（`Cmd+P`）で印刷ダイアログを開く
3. 「送信先」→「PDFとして保存」
4. レイアウト：**横向き**
5. 余白：**なし**
6. 背景のグラフィック：**ON**

---

### 8) 注意事項

1. **スライド枚数厳守**: 構成案のスライド枚数を1枚たりとも変えないこと。スライドの統合・分割は不可

2. **テキスト最小化**: 忙しいオーナーが一目で分かるデザインにする。長文は禁止

3. **フォントサイズの最低基準を厳守**:
   - 本文・箇条書き: 最低 `17px`（`12px` や `13px` は絶対に使用禁止）
   - 表セル: 最低 `16px`
   - インラインの補足テキスト: 最低 `16px`
   - 唯一 `14px` を許容するのはグラフの軸ラベルのみ
   - スライド上のテキストが小さすぎると、オーナーが読めないため、意味がない

4. **グラフの装飾は必ず実施**:
   - すべてのグラフに **最低1つのアノテーション（吹き出し・矢印・バッジのいずれか）** を付ける
   - 好調/不調の色分けは **必ず** 行う
   - 最大値・最小値のデータラベルは **フォントサイズと太さで強調**
   - 基準線（4週平均、前年値など）を **破線で表示**
   - **強調手法は吹き出しだけでなく、トレンド矢印・丸囲み・背景帯・太枠・バッジを組み合わせる**（4.2 b-3参照）
   - **折れ線グラフには必ずトレンド矢印を追加する**
   - **複数指標の比較グラフは割合棒グラフ（100%基準線付き）を使用する**

5. **テーブルの主張連動ハイライト**:
   - msg-barで主張している内容に関連するデータ行は、背景色変更・左ボーダー・太字などで強調する
   - 最大カテゴリ、最大商品、最大変化のある行を必ずハイライトする

6. **カード・箇条書きには絵文字を添える**:
   - success-item / challenge-item カードの見出しに内容に合った絵文字を追加
   - bullet-list の .icon 要素に番号の代わりに絵文字を使用
   - カード型まとめの行頭に絵文字を添える

7. **「達成・未達成」の使い方**
   - 「達成」「未達」「達成率」は **明確な目標値に対して** 使う言葉。目標値が設定されている場合のみ使用する
   - 前年同週との比較は目標ではない。「達成率」ではなく **「前年比+◯%」「前年比-◯%」** と表現する
   - 4週平均との比較も同様。「達成率◯%」ではなく **「4週平均比+◯%」「4週平均の◯割水準」** 等と表現する

8. **スライド上の表記は日本語を使う**
   - カタカナ英語・英語表記はなるべく避け、日本語で表現する
   - 特に以下のような表現は使わない:
     - NG: 「サイズ」→ OK: 「規模」「人数」
     - NG: 「ケース」→ OK: 「件」「事例」
     - NG: 「カウント」→ OK: 「件数」「数」
     - NG: 「セールス」→ OK: 「売上」
     - NG: 「トップ10」→ OK: 「上位10商品」
     - NG: 「Win / Loss」→ OK: 「強み / 課題」
   - 固有名詞（商品名・店舗名・サービス名など）はそのまま英語表記でOK
   - 一般に広く使われ日本語に置き換えると不自然なもの（KPI、SNS等）は許容する

9. **単一HTMLファイル完結**
   - CSSは `<style>` タグ内、JSは `<script>` タグ内にすべて記述
   - 外部参照は D3.js CDN のみ
   - 画像ファイルの外部参照は不可（SVGインラインまたはCSSで代替）

10. **ブラウザ互換性**
   - Chrome / Edge / Firefox の最新版で正しく表示されること
   - PDF出力時に全グラフが正しく描画されること

---

## セルフチェック（作成後に必ず実行）

以下の全項目を確認してからファイルを保存すること:

- [ ] スライド枚数が構成案と一致しているか
- [ ] 各スライドのタイトルが構成案と一致しているか
- [ ] 表内の文字・数値が構成案と完全に一致しているか（1セルずつ照合）
- [ ] 商品名・カテゴリ名に表記揺れがないか（構成案と1文字ずつ比較）
- [ ] **各グラフに最低1つのアノテーション（吹き出し or 矢印）が付いているか**
- [ ] **好調/不調の色分けが正しく適用されているか**（グリーン/レッド）
- [ ] **最大値・最小値のフォントサイズが周囲より大きいか**
- [ ] **基準線（4週平均・前年値）が破線で表示されているか**
- [ ] **右端のデータポイントの吹き出しが見切れていないか**（右端にある場合は左にオフセットされているか）
- [ ] **全スライドに主張バー（msg-bar）が配置されているか**（タイトルスライド以外）
- [ ] **全テキストが最低フォントサイズ基準（本文17px、表16px、グラフ内14px以上）を満たしているか**
- [ ] **グラフ内のデータラベルが16px以上、チャートタイトルが20px以上になっているか**
- [ ] **折れ線グラフにトレンド矢印（直前→当週の変化方向）が描画されているか**
- [ ] **複数指標比較グラフ（売上・客数・客単価）で割合棒グラフ（100%基準線付き）を使用しているか**
- [ ] **棒グラフの最大値バーに太枠・バッジ・背景帯のいずれかの強調が適用されているか**
- [ ] **テーブルでmsg-barの主張に関連する行がハイライトされているか**
- [ ] **カード・箇条書き・まとめに絵文字が添えられているか**
- [ ] **ドーナツチャートの最大セグメントが外側に突出しているか**
- [ ] PDFで改ページが各スライドの境界で正しく発生するか
- [ ] D3.jsのグラフがブラウザで正しく描画されるか
- [ ] HTMLファイルが単体で開けるか（外部ファイル依存なし、D3.js CDN除く）

---

## チェックリスト（フェーズ5完了条件）
- `{出力ディレクトリ}` にHTMLファイルが保存されている
- ブラウザで開いてすべてのスライドが正しく表示される
- D3.jsグラフがすべて描画されている
- PDF出力時に1スライド=1ページで分離される
- アノテーション・色分け・フォント強調が全グラフに適用されている
