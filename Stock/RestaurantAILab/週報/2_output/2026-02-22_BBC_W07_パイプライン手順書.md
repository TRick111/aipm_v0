# BBC W07 一気通貫パイプライン手順書

- **作成日**: 2026-02-22
- **目的**: 新パイプライン（Node.js export-rawdata.mjs）のフルフロー検証
- **対象**: BBC（別天地 銀座）W07（2026-02-09 〜 2026-02-15）
- **環境**: ローカル（dev、localhost:3000）

---

## 変数一覧

| 変数 | 値 |
|------|-----|
| startDate | 2026-02-09 |
| endDate | 2026-02-15 |
| storeCode | bbc-001 |
| storeName | 別天地　銀座 |
| 週番号 | W07 (2026w07) |
| Dashboard | /Users/rikutanaka/RestaurantAILab/Dashboard |
| 週報 | /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報 |
| Dinii Email | bbc-dashboard1@shop.dinii.jp |
| Dinii Password | 6858bc5682 |

---

## Step 0: Dinii POS ダウンロード（Playwright）

### 目的
Dinii管理画面から注文一覧CSVをダウンロードする。

### 手順

1. Playwright MCP で https://dashboard.self.dinii.jp/signIn にアクセス
2. ログイン: bbc-dashboard1@shop.dinii.jp / 6858bc5682
3. 左メニュー「分析」→「CSVダウンロード」
4. 店舗選択: 「全選択」を外し、「別天地 銀座」を選択
5. 期間設定: 2026-02-09 〜 2026-02-15
6. 「注文一覧」にチェック → ダウンロード
7. ファイルを以下にリネーム・配置:
   ```
   週報/0_downloads/20260209-20260215-別天地 銀座-orders.csv
   ```
8. 「会計一覧」もチェックしてダウンロード（transactions用）:
   ```
   週報/0_downloads/20260209-20260215-別天地 銀座-transactions.csv
   ```
9. ログアウト

### Mac対応パス
- ダウンロード先: ~/Downloads（Windowsの `C:\Users\auk1i\Downloads` ではなく）
- ダウンロード後に `週報/0_downloads/` へ移動

### フォールバック
W07データは `0_downloads/` に既に存在する。Playwrightが動作しない場合、既存ファイルを使用:
- `0_downloads/20260209-20260215-別天地 銀座-orders.csv`（82,919 bytes）
- `0_downloads/20260209-20260215-別天地 銀座-transactions.csv`（4,028 bytes）

### 完了条件
- [ ] orders.csv と transactions.csv が `0_downloads/` に存在すること

---

## Step 1: ファイル配置 + Dashboard アップロード

### 目的
ダウンロードしたCSVをDashboard APIにアップロードする。

### 1-1. ファイル配置

`bulk-upload-dinii.mjs` が期待するディレクトリ構造にファイルを配置する:

```bash
cd /Users/rikutanaka/RestaurantAILab/Dashboard

# ディレクトリ作成
mkdir -p .local/bulkupload/bbc-001/2026-02

# ファイルコピー＆リネーム（スクリプトは orders.csv / transactions.csv を期待）
cp "/Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/0_downloads/20260209-20260215-別天地 銀座-orders.csv" \
   .local/bulkupload/bbc-001/2026-02/orders.csv

cp "/Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/0_downloads/20260209-20260215-別天地 銀座-transactions.csv" \
   .local/bulkupload/bbc-001/2026-02/transactions.csv
```

**注意**: `bulk-upload-dinii.mjs` は `orders.csv` または `*_orders.csv` を検索する。
元ファイル名（`-orders.csv`）はマッチしないため、`orders.csv` にリネームが必要。

### 1-2. アップロード実行

```bash
cd /Users/rikutanaka/RestaurantAILab/Dashboard
node scripts/bulk-upload-dinii.mjs --store bbc-001
```

### 期待される出力
```
=== Dinii Bulk Upload Script ===
Store: bbc-001
Source: .local/bulkupload/bbc-001
Found 1 month folders: 2026-02
Uploading 2026-02: orders.csv + transactions.csv
  ✓ Success: N records uploaded
```

既にアップロード済みの場合は `inserted=0, skipped=N` となるが正常。

### 完了条件
- [ ] アップロードが成功（success）すること
- [ ] または skipped=N で既存データとして認識されること

---

## Step 2: rawdata.csv エクスポート

### 目的
Dashboard APIから指定期間のデータをエクスポートし、rawdata.csv を生成する。

### 実行コマンド

```bash
cd /Users/rikutanaka/RestaurantAILab/Dashboard

node scripts/export-rawdata.mjs \
  --store bbc-001 \
  --start-date 2026-02-09 \
  --end-date 2026-02-15 \
  --output /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/1_input/BBC/rawdata.csv
```

### 期待される出力
```
=== rawdata.csv Export Script ===
Store: bbc-001 (別天地　銀座)
Period: 2026-02-09 ~ 2026-02-15
✓ Logged in as admin
Fetching data for 2026-02...
  → 337 records (21 accounts)
✓ Exported 337 rows to .../1_input/BBC/rawdata.csv
```

### 検証

```bash
# レコード数確認
wc -l /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/1_input/BBC/rawdata.csv

# ヘッダー確認（18カラム）
head -1 /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/1_input/BBC/rawdata.csv

# サンプルデータ確認
head -3 /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/1_input/BBC/rawdata.csv
```

### 完了条件
- [ ] rawdata.csv が生成されていること
- [ ] レコード数が0でないこと
- [ ] 18カラム構造が正しいこと

---

## Step 3: 週報生成（Phase 1 → 2 → 3 → 5）

### 出力ディレクトリ

```bash
mkdir -p /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報/2_output/BBC/2_output_2026w07_v2
```

`_v2` を付けて既存W07出力と区別する。

### Phase 1: 基礎資料作成

```bash
cd /Users/rikutanaka/aipm_v0/Stock/RestaurantAILab/週報

python3 Scripts/analysis_script.py \
  --store BBC \
  --start-date 2026-02-09 \
  --end-date 2026-02-15
```

出力ファイル:
- `analysis_results.json`
- `weekday_decomposition.csv`
- `weekly_sales.csv`, `hourly_sales.csv`
- `category_latest.csv`, `product_latest.csv`
- PNGグラフ6枚

→ 出力をもとに `週報作成基礎資料.md` を作成（`01_週報作成プロンプトテンプレート.md` に従う）

### Phase 2: 曜日深堀分析

```bash
python3 Scripts/deep_dive_weekday_analysis.py \
  --store BBC \
  --start-date 2026-02-09 \
  --end-date 2026-02-15
```

→ 結果を `週報作成基礎資料.md` に追記（`02_曜日深堀分析_プロンプト.md` に従う）

### Phase 3: スライド構成案作成

`03_スライド構成案作成_プロンプト.md` に従い、基礎資料をもとに28枚構成のスライド案を作成。

→ `週報スライド構成案.md` を出力

### Phase 4: 日報スライド（スキップ）

BBC の DailyReport.csv がないためスキップ。

### Phase 5: HTMLスライド生成

`05_HTMLスライド作成_プロンプト.md` に従い、D3.js + HTML で単一ファイルスライドを生成。

→ `20260209_20260215_別天地_銀座_週次報告資料.html` を出力

### 完了条件
- [ ] `analysis_results.json` が生成されていること
- [ ] `週報作成基礎資料.md` が作成されていること
- [ ] `週報スライド構成案.md` が作成されていること
- [ ] HTML スライドが生成されていること
- [ ] HTML をブラウザで開いてグラフが表示されること

---

## 全体の完了条件

| Step | チェック項目 |
|------|------------|
| Step 0 | orders.csv + transactions.csv が存在 |
| Step 1 | Dashboard アップロード成功 |
| Step 2 | rawdata.csv が18カラム・N行で生成 |
| Step 3 | HTML週報が正常に生成・表示 |

---

## トラブルシューティング

| 症状 | 対処 |
|------|------|
| Playwright MCP が使えない | 既存 0_downloads/ ファイルをフォールバックとして使用 |
| Dashboard dev サーバーが起動していない | `cd Dashboard && npm run dev` |
| `ECONNREFUSED` | Dashboard サーバーの起動を確認 |
| `inserted=0, skipped=N` | 正常（既存データ）。エクスポートは可能 |
| `No data found` | アップロードが完了しているか確認 |
| analysis_script.py エラー | rawdata.csv の構造・日付範囲を確認 |
