# 飲食店 週報分析 手順書（曜日×客数要因／客単価要因）

本手順書は、**既に整備済みのPOS売上データ**を前提として、  
毎週同じロジックで「曜日別に売上変化を要因分解し、深掘り分析する」ための  
**再現可能な分析仕様書**です。

主眼は以下の2点です。

- **曜日ごとに、売上変化を「客数要因（covers）」と「客単価要因（1人単価）」に分解すること**
- **プラス／マイナスの影響が大きい曜日について、会計・明細レベルまで掘り下げて原因仮説を立てること**

---

## 1. ゴールと必須アウトプット

### 1.1 ゴール
毎週、以下を必ず実行できる状態を作る。

1. 当週と前週（同営業曜日）で売上を比較する  
2. **曜日別**に売上差分を  
   - 客数要因（covers要因）  
   - 客単価要因（1人単価要因）  
   に分解する（ミッドポイント法）
3. 要因寄与の大きい曜日について  
   **「なぜそうなったのか」をデータから説明し、仮説を立てる**

### 1.2 必須アウトプット
週報の基礎資料として、最低限以下を出力する。

- 週次KPI（当週／前週）
- 曜日別KPI（当週／前週）
- 曜日別 売上差分の要因分解  
  - 売上差  
  - 客数要因寄与  
  - 客単価要因寄与  
  - 検算（寄与合計＝売上差）
- 最大プラス／最大マイナス曜日の深掘り分析（数値＋仮説）

---

## 2. 時刻・営業日の扱い（分析前提として固定）

### 2.1 UTC → JST 変換
- すべての時刻は **UTC → JST（+9時間）** に変換する
- **実装済み**: `analysis_script.py`では`entry_at`, `exit_at`, `ordered_at`を自動変換

```python
# UTC → JST 変換の実装例
sales_df['entry_at'] = pd.to_datetime(sales_df['entry_at'], utc=True)
sales_df['entry_at_jst'] = sales_df['entry_at'].dt.tz_convert('Asia/Tokyo')
```

### 2.2 営業日（business_date）の定義
営業時間が **18:00〜26:00（翌2:00）前後**である前提のため、
JST時刻を以下のルールで営業日に紐づける。

- **00:00〜05:59** の会計 → 前日の営業日に付け替え
- **06:00〜23:59** の会計 → 当日の営業日

例：
- 2025-10-25 01:37（JST）→ business_date = 2025-10-24
- 2025-10-24 21:10（JST）→ business_date = 2025-10-24

**実装済み**: `analysis_script.py`では`get_business_date()`関数で自動計算

```python
def get_business_date(dt):
    """JSTの日時から営業日を計算"""
    if pd.isna(dt):
        return None
    hour = dt.hour
    if 0 <= hour < 6:
        return (dt - pd.Timedelta(days=1)).date()
    else:
        return dt.date()
```

### 2.3 時間帯バケット（任意だが推奨）
深夜帯を分析しやすくするため、以下を作成する。

- `business_hour` **（実装済み）**
  - 0時 → 24、1時 → 25、2時 → 26 …（深夜は +24 表記）
- `hour_bucket` 例 **（実装済み）**
  - 18-19
  - 20-21
  - 22-23
  - 24-25+
  - other（営業時間外・例外）

```python
def get_business_hour(dt):
    """JSTの日時から営業時間を計算（0時→24、1時→25...）"""
    hour = dt.hour
    if 0 <= hour < 6:
        return hour + 24
    else:
        return hour

def get_hour_bucket(hour):
    """営業時間に基づいた時間帯バケット"""
    if 18 <= hour < 20:
        return '18-19'
    elif 20 <= hour < 22:
        return '20-21'
    elif 22 <= hour < 24:
        return '22-23'
    elif 24 <= hour < 26:
        return '24-25+'
    else:
        return 'other'
```

---

## 3. 当週／前週の切り出し

### 3.1 当週（target week）
- `business_date` を基準に、対象週の営業日レンジを指定する

### 3.2 前週（previous week）
- 当週レンジを **7日戻した営業日レンジ**を前週とする

### 3.3 注意点
- 曜日比較は必ず **business_date（営業日）基準**で行う  
- 深夜売上は翌暦日ではなく、前日の営業日に含まれていることを意識する

---

## 4. KPI定義（計算式を固定）

売上は **明細 subtotal の合計**を基準とする。

- 売上 `S`：`sum(subtotal)`
- 来店人数 `P`：`sum(covers)`
- 会計数 `C`：`count_distinct(check_id)`
- 1人単価 `A_person`：`S / P`
- 平均人数／会計 `U`：`P / C`
- 会計単価 `A_check`：`S / C`

推奨（分布確認）：
- 会計別 `check_subtotal`
- 会計別 `check_per_person = check_subtotal / covers`
- 中央値 / P10 / P90 を併記

---

## 5. 曜日別 売上差分の要因分解（最重要）

### 5.1 曜日別KPI作成
曜日 `d` ごとに、当週・前週それぞれ以下を算出する。

- 当週：`S1[d]`, `P1[d]`, `A1[d] = S1[d] / P1[d]`
- 前週：`S0[d]`, `P0[d]`, `A0[d] = S0[d] / P0[d]`
- 売上差：`ΔS[d] = S1[d] - S0[d]`

### 5.2 ミッドポイント法による分解
売上 `S = P × A` を用い、差分を以下で分解する。

- **客数要因寄与**
Contrib_P[d] = (P1[d] - P0[d]) × (A1[d] + A0[d]) / 2

markdown
常に詳細を表示する

コードをコピーする

- **客単価要因寄与**
Contrib_A[d] = (A1[d] - A0[d]) × (P1[d] + P0[d]) / 2

markdown
常に詳細を表示する

コードをコピーする

- **検算**
Contrib_P[d] + Contrib_A[d] = ΔS[d]

markdown
常に詳細を表示する

コードをコピーする

### 5.3 P=0 の例外処理
- `P0=0` または `P1=0` の場合  
  - 単価要因は 0 とする  
  - 差分はすべて客数要因に寄せる  
  - 注記を必ず付与する

### 5.4 週全体の要因寄与
週次の要因は **曜日別寄与の合計**で定義する。

- `ΔS_week = Σ ΔS[d]`
- `Contrib_P_week = Σ Contrib_P[d]`
- `Contrib_A_week = Σ Contrib_A[d]`

---

## 6. 深掘り対象曜日の抽出ルール

以下を必ず抽出する。

- 客数要因 最大マイナス曜日
- 客単価要因 最大マイナス曜日
- 客数要因 最大プラス曜日
- 客単価要因 最大プラス曜日

加えて、寄与の**絶対値が大きい曜日（上位2〜3）**も深掘り候補とする。

---

## 7. 深掘り分析の手順（原因仮説を作る）

対象曜日 `d*` について、当週 vs 前週で必ず以下を確認する。

### 7.1 結論サマリー（最初に書く）
- 当週／前週の `S, P, A_person, C, U`
- `ΔS`, `Contrib_P`, `Contrib_A`
- ひとことで  
  - 人数が原因か  
  - 単価が原因か  
  - 両方か

---

### 7.2 パーティサイズ分析
- ビン例：1名 / 2名 / 3–4名 / 5名以上 / unknown
- 当週／前週で以下を比較：
  - 人数
  - 売上
  - 1人単価

**見るポイント**
- 団体（5名以上）の消失・増加
- 少人数客の増減
- 単価が落ちやすい人数帯の構成変化

---

### 7.3 時間帯バケット分析
- `hour_bucket` 別に当週／前週の
  - 人数
  - 売上
  - 1人単価
を比較する。

**見るポイント**
- 深夜（24-25+）の有無
- ピーク（20-21）の団体消失
- 22-23 の伸長／落ち込み

---

### 7.4 会計レベルの確認（必須）
対象曜日は必ず会計一覧まで降りる。

- 会計別：
  - `check_subtotal`
  - `covers`
  - `check_per_person`
  - 時刻（JST）

**確認すること**
- 前週に存在した大口会計が当週に無いか
- 当週に新規の大口会計があるか
- 外れ値か、分布全体の変化か（中央値・P10・P90）

---

### 7.5 商品ミックス分析
#### 大分類（category）
- 売上／人
- 数量／人
を当週／前週で比較。

#### 商品レベル
- 売上差が大きい商品
- 数量差が大きい商品

**見るポイント**
- 高単価商品か、追加注文（点数）が要因か
- ドリンク／フードのどちらが単価ドライバーか
- コース比率増加による単価低下が起きていないか

---

### 7.6 例外データの確認
- 営業時間外会計の混入
- 明細1行のみ・数量異常などの特殊計上
- covers と quantity の不整合

必要に応じて「通常営業」と「イベント／特殊売上」を切り分ける。

---

## 8. 仮説のまとめ方

### 8.1 仮説は 2〜4 個に絞る
各仮説は必ず以下を含める。

- 仮説（何が起きたか）
- データ根拠（具体的な数値）
- 追加確認事項（予約台帳、スタッフ体制、運用ルール等）

### 8.2 次週の観測指標（先行指標）
- 5名以上人数
- 深夜帯人数
- 酒類点数／人
- フード点数／人
- コース人数比率（可能なら）

---

## 9. 品質チェックリスト

### データ処理の確認
- ✅ UTC → JST変換されている（`entry_at_jst`カラムが存在）
- ✅ 深夜会計が前日営業日に付いている（`business_date`を確認）
- ✅ 営業時間外データが適切に識別されている（`hour_bucket='other'`の件数確認）
- ✅ `business_hour`で深夜が24時以降表記になっている

### 要因分解の検算
- ✅ 曜日別で `Contrib_P + Contrib_A = ΔS`（誤差は丸め誤差のみ）
- ✅ 週全体寄与が曜日別寄与の合計になっている
- ✅ P=0の例外処理が正しく動作している

### 分析品質の確認
- ✅ 深掘りは最低2観点以上で説明できている
- ✅ 仮説にデータ根拠と追加確認が付いている
- ✅ 曜日は営業日基準で集計されている（暦日ではない）
- ✅ 時間別分析が営業時間帯（18-25時）を中心に行われている

### 出力ファイルの確認
- ✅ `weekday_decomposition.csv`に曜日別要因分解データが保存されている
- ✅ グラフに深夜帯（24時以降）が適切に表示されている
- ✅ メモファイルにUTC→JST変換の情報が記載されている